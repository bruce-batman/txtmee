<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Asklyy — Send Anonymous Messages</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f172a; --card:rgba(15,23,42,0.85); --muted:#94a3b8; --accent:#3b82f6; --glass:rgba(255,255,255,0.03);
      color-scheme: dark;
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    body{margin:0;background:linear-gradient(180deg,#071027 0%,var(--bg) 100%);min-height:100vh;color:#e6eef8;display:flex;align-items:center;justify-content:center;padding:32px;}
    .container{width:100%;max-width:920px;}
    .card{background:var(--card);padding:20px;border-radius:12px;box-shadow:0 10px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03);}
    header{display:flex;gap:12px;align-items:center;margin-bottom:16px}
    .logo{width:46px;height:46px;border-radius:10px;background:linear-gradient(90deg,#6366f1,#3b82f6);display:inline-flex;align-items:center;justify-content:center;font-weight:700;color:white}
    h1{margin:0;font-size:18px}
    p.lead{margin:4px 0 0;color:var(--muted);font-size:13px}
    .row{display:flex;gap:12px;align-items:center}
    .col{display:flex;flex-direction:column;gap:8px}
    input[type="text"],input[type="password"],textarea{
      background:var(--glass);border:1px solid rgba(255,255,255,0.03);padding:10px;border-radius:8px;color:inherit;font-size:14px;width:100%;
    }
    button{background:var(--accent);border:none;color:white;padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:600}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:12px;color:var(--muted)}
    .actions{display:flex;gap:8px;align-items:center}
    .link-card{background:linear-gradient(180deg, rgba(59,130,246,0.12), rgba(99,102,241,0.06));padding:10px;border-radius:8px;color:#dbeafe;display:flex;justify-content:space-between;align-items:center}
    .messages{margin-top:12px;max-height:360px;overflow:auto;padding-right:6px}
    .message{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;margin-bottom:8px}
    .message .meta{font-size:12px;color:var(--muted);margin-bottom:6px}
    .controls{display:flex;gap:8px;align-items:center}
    .center{display:flex;align-items:center;justify-content:center}
    .notice{padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);margin-top:8px;color:var(--muted);font-size:13px}
    @media (max-width:720px){body{padding:18px}.row{flex-direction:column;align-items:stretch}}
  </style>
</head>
<body>
  <div class="container">
    <div class="card" id="app">
      <header>
        <div class="logo">A</div>
        <div>
          <h1>Asklyy</h1>
          <p class="lead">Create a sharable link and receive anonymous messages</p>
        </div>
      </header>

      <!-- MAIN / DASHBOARD / SEND views will be injected here -->
      <div id="view"></div>
    </div>
  </div>

  <script>
    /**
     * Frontend logic:
     * - root "/" shows create-account / login (and short info)
     * - dashboard shows link, messages (autorefresh every 1s), logout, delete account
     * - /send/?id=LINKID shows public send form
     *
     * Requirements: backend endpoints:
     *   POST /api/createlink    { username, password } => { success:true, linkId }
     *   GET  /api/getmessages?linkId=...   (protected - pass Authorization: Basic)
     *   POST /api/sendmessages   { linkId, name, text }  => accept anonymous submissions
     *   POST /api/dltlink        { linkId } (protected)
     *   POST /api/dltmessage     { linkId, messageId } (protected)
     *
     * The frontend stores username/password in sessionStorage while logged in (so refresh keeps session).
     */

    const API_PREFIX = '/api';
    const view = document.getElementById('view');
    const pollIntervalMs = 1000; // 1s
    let messagesPollId = null;
    let lastMessages = [];

    // ---------- Helpers ----------
    function show(html){ view.innerHTML = html; }
    function qs(sel, root=document) { return root.querySelector(sel); }
    function qsa(sel, root=document) { return Array.from(root.querySelectorAll(sel)); }

    function basicAuthHeader() {
      const u = sessionStorage.getItem('asklyy_username');
      const p = sessionStorage.getItem('asklyy_password');
      if (!u || !p) return null;
      return 'Basic ' + btoa(u + ':' + p);
    }

    async function apiPost(path, body, auth=false) {
      const headers = { 'Content-Type': 'application/json' };
      if (auth) {
        const h = basicAuthHeader();
        if (!h) throw new Error('Not authenticated');
        headers['Authorization'] = h;
      }
      const res = await fetch(API_PREFIX + path, { method: 'POST', headers, body: JSON.stringify(body) });
      const j = await res.json().catch(()=>({success:false, error:'Invalid JSON response'}));
      if (!res.ok) throw new Error(j && j.error ? j.error : 'API Error');
      return j;
    }

    async function apiGet(path, auth=false) {
      const headers = {};
      if (auth) {
        const h = basicAuthHeader();
        if (!h) throw new Error('Not authenticated');
        headers['Authorization'] = h;
      }
      const res = await fetch(API_PREFIX + path, { method:'GET', headers });
      const j = await res.json().catch(()=>({success:false, error:'Invalid JSON response'}));
      if (!res.ok) throw new Error(j && j.error ? j.error : 'API Error');
      return j;
    }

    function navigateToRoot() {
      history.replaceState({}, '', '/');
      route();
    }

    function route() {
      // If path starts with /send/ or query param id present -> show send page
      const url = new URL(location.href);
      const id = url.searchParams.get('id');
      if (location.pathname.startsWith('/send') || id) {
        const linkId = id || (location.pathname.split('/send/')[1] || '').replace('/', '');
        renderSendPage(linkId);
        return;
      }

      // else main/dashboard
      const username = sessionStorage.getItem('asklyy_username');
      const password = sessionStorage.getItem('asklyy_password');
      if (username && password) {
        renderDashboard();
      } else {
        renderMain();
      }
    }

    // ---------- MAIN (create / login) ----------
    function renderMain() {
      stopPolling();
      show(`
        <div>
          <h2 style="margin:0 0 10px">Welcome to Asklyy</h2>
          <p class="muted">Create a short link to receive anonymous messages. Share that link (e.g. https://asklyy.vercel.app/send/?id=abc123) — people can send messages without logging in.</p>

          <div style="display:flex;gap:12px;margin-top:16px;flex-wrap:wrap">
            <div style="flex:1;min-width:240px">
              <div style="font-weight:600;margin-bottom:8px">Create account & link</div>
              <input id="new_username" placeholder="Choose a username (letters/numbers)" />
              <input id="new_password" placeholder="Choose a password" type="password" style="margin-top:8px" />
              <div style="margin-top:8px" class="actions">
                <button id="createBtn">Create & Generate Link</button>
                <button id="demoBtn" class="ghost">Demo (quick)</button>
              </div>
              <div id="createMsg" class="small muted"></div>
            </div>

            <div style="flex:1;min-width:240px">
              <div style="font-weight:600;margin-bottom:8px">Already have an account? Log in</div>
              <input id="login_username" placeholder="Username" />
              <input id="login_password" type="password" placeholder="Password" style="margin-top:8px" />
              <div style="margin-top:8px" class="actions">
                <button id="loginBtn">Log in</button>
              </div>
              <div id="loginMsg" class="small muted"></div>
            </div>
          </div>

          <div class="notice">
            <strong>Shareable send URL format:</strong> <span id="exampleUrl" class="small"></span>
          </div>
        </div>
      `);

      const createBtn = qs('#createBtn');
      const loginBtn = qs('#loginBtn');
      const demoBtn = qs('#demoBtn');
      const ex = qs('#exampleUrl');
      ex.textContent = `${location.origin}/send/?id/your-link-id  (example)`;

      createBtn.onclick = async () => {
        const u = qs('#new_username').value.trim();
        const p = qs('#new_password').value;
        const msg = qs('#createMsg');
        msg.textContent = '';
        if (!u || !p) { msg.textContent = 'username & password required'; return; }
        try {
          createBtn.disabled = true;
          createBtn.textContent = 'Creating...';
          const res = await apiPost('/createlink', { username: u, password: p }, false);
          if (res && res.linkId) {
            sessionStorage.setItem('asklyy_username', u);
            sessionStorage.setItem('asklyy_password', p);
            // store linkId too
            sessionStorage.setItem('asklyy_linkId', res.linkId);
            navigateToRoot(); // will go to dashboard
            return;
          }
          msg.textContent = 'Unexpected response from server';
        } catch (err) {
          msg.textContent = 'Error: ' + (err.message || err);
        } finally {
          createBtn.disabled = false;
          createBtn.textContent = 'Create & Generate Link';
        }
      };

      demoBtn.onclick = async () => {
        // demo quick flow: create a random username and password
        const demoU = 'demo' + Math.random().toString(36).slice(2,8);
        const demoP = Math.random().toString(36).slice(2,10);
        qs('#new_username').value = demoU;
        qs('#new_password').value = demoP;
        createBtn.click();
      };

      loginBtn.onclick = async () => {
        const u = qs('#login_username').value.trim();
        const p = qs('#login_password').value;
        const msg = qs('#loginMsg');
        msg.textContent = '';
        if (!u || !p) { msg.textContent = 'username & password required'; return; }
        try {
          // We will verify log in by attempting to GET messages for that user's linkId (the backend needs to accept auth)
          // First, try to find user's link by calling getmessages with no link -> backend may require linkId,
          // so we rely on server-side to accept basic auth and return a user object via a special method.
          // Simpler: store login credentials and request /api/getmessages?linkId= (server will check auth)
          sessionStorage.setItem('asklyy_username', u);
          sessionStorage.setItem('asklyy_password', p);
          // Attempt to fetch linkId from /api/getmessages?linkId=NONE to cause auth-check; if it fails,
          // we will fallback by asking user to re-enter credentials later.
          try {
            // Optional: server could expose an endpoint to return current user's linkId. If not present,
            // the create/login flow will still work because the server returns linkId on create.
            // We skip extra verification here and just go to dashboard — dashboard will show error if auth fails.
            navigateToRoot();
          } catch (err) {
            msg.textContent = 'Login failed: ' + (err.message || err);
            sessionStorage.removeItem('asklyy_username');
            sessionStorage.removeItem('asklyy_password');
          }
        } catch (err) {
          msg.textContent = 'Login error: ' + (err.message || err);
        }
      };
    }

    // ---------- DASHBOARD ----------
    async function renderDashboard() {
      const uname = sessionStorage.getItem('asklyy_username');
      let linkId = sessionStorage.getItem('asklyy_linkId') || '';
      // If we don't yet know linkId, try to get it by calling /api/getmessages?linkId=...(no). Many servers provide an endpoint to return user; if your server doesn't you'll rely on create step to set linkId in sessionStorage.
      show(`<div>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:700">${uname || 'User'}</div>
            <div class="small muted">Manage your shareable link & messages</div>
          </div>
          <div class="controls">
            <button id="logoutBtn" class="ghost">Logout</button>
            <button id="deleteBtn" class="ghost">Delete Account</button>
            <button id="refreshBtn">Refresh</button>
          </div>
        </div>

        <div style="margin-top:12px" class="link-card">
          <div>
            <div class="small muted">Share this URL to receive anonymous messages</div>
            <div id="shareUrl" style="font-weight:600;margin-top:6px"></div>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
            <div class="small muted">Link ID</div>
            <div id="linkIdText" style="font-weight:700"></div>
          </div>
        </div>

        <div class="messages" id="messagesBox">
          <div class="muted small center">Loading messages...</div>
        </div>
      </div>`);

      const logoutBtn = qs('#logoutBtn');
      const deleteBtn = qs('#deleteBtn');
      const refreshBtn = qs('#refreshBtn');
      const linkIdText = qs('#linkIdText');
      const shareUrlEl = qs('#shareUrl');

      // If we don't have linkId in sessionStorage, try to obtain it: some backends will include it on login; if not, you must create it first.
      if (!linkId) {
        // attempt to call a small endpoint to discover linkId (not present in code by default) — fallback: ask user to re-create
        linkIdText.textContent = '(unknown) — create an account first';
        shareUrlEl.textContent = '—';
      } else {
        linkIdText.textContent = linkId;
        shareUrlEl.innerHTML = `<a href="${location.origin}/send/?id=${encodeURIComponent(linkId)}" target="_blank" style="color:inherit; text-decoration:underline">${location.origin}/send/?id=${encodeURIComponent(linkId)}</a>`;
      }

      logoutBtn.onclick = () => {
        stopPolling();
        sessionStorage.removeItem('asklyy_username');
        sessionStorage.removeItem('asklyy_password');
        // keep linkId stored? we remove it so login flow is clean
        sessionStorage.removeItem('asklyy_linkId');
        navigateToRoot();
      };

      deleteBtn.onclick = async () => {
        const ok = confirm('Delete your account and ALL messages for this link? This cannot be undone.');
        if (!ok) return;
        try {
          deleteBtn.disabled = true;
          const header = basicAuthHeader();
          if (!header) throw new Error('Not authenticated');
          // call delete link API
          const res = await apiPost('/dltlink', { linkId }, true);
          alert('Account deleted. Redirecting to main page.');
          logoutBtn.click();
        } catch (err) {
          alert('Delete failed: ' + (err.message || err));
        } finally {
          deleteBtn.disabled = false;
        }
      };

      refreshBtn.onclick = async () => {
        await fetchAndRenderMessages(linkId);
      };

      // Start polling messages every 1s when on this dashboard
      startPolling(() => fetchAndRenderMessages(linkId));
      // initial fetch
      fetchAndRenderMessages(linkId);
    }

    async function fetchAndRenderMessages(linkId) {
      const box = qs('#messagesBox');
      if (!linkId) {
        box.innerHTML = '<div class="muted small">No link id known. Create account first.</div>';
        return;
      }
      try {
        box.innerHTML = '<div class="muted small center">Refreshing...</div>';
        // GET /api/getmessages?linkId=...   (requires auth)
        const res = await apiGet('/getmessages?linkId=' + encodeURIComponent(linkId), true);
        if (res && res.messages) {
          lastMessages = res.messages;
          if (res.messages.length === 0) {
            box.innerHTML = '<div class="muted small center">No messages yet — share your link.</div>';
            return;
          }
          // render messages
          box.innerHTML = res.messages.map(m => {
            // message object: { messageId, name, text, createdAt }
            const name = m.name ? escapeHtml(m.name) : 'Anonymous';
            const text = escapeHtml(m.text || '');
            const date = m.createdAt ? new Date(m.createdAt).toLocaleString() : '';
            const deleteBtn = `<button data-id="${m.messageId}" class="ghost small-btn" style="padding:6px;border-radius:6px">Delete</button>`;
            return `<div class="message">
                      <div class="meta">${name} • <span class="small muted">${date}</span></div>
                      <div>${text}</div>
                    </div>`;
          }).join('');
        } else {
          box.innerHTML = '<div class="muted small center">No items</div>';
        }
      } catch (err) {
        box.innerHTML = `<div class="muted small center">Error loading messages: ${escapeHtml((err && err.message) || String(err))}</div>`;
      }
    }

    // ---------- SEND PAGE ----------
    function renderSendPage(linkIdFromUrl) {
      stopPolling();
      const linkId = linkIdFromUrl || '';
      show(`
        <div>
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:700">Send anonymous message</div>
              <div class="small muted">To link: <strong id="sendLinkId">${escapeHtml(linkId)}</strong></div>
            </div>
            <div class="actions">
              <button id="homeBtn" class="ghost">Home</button>
            </div>
          </div>

          <form id="sendForm" style="margin-top:12px">
            <div class="col">
              <label class="small muted">Your name (optional)</label>
              <input id="senderName" placeholder="Name (optional)" />
              <label class="small muted">Message</label>
              <textarea id="senderText" rows="5" placeholder="Write your anonymous message..." required></textarea>
              <div style="display:flex;gap:8px;margin-top:8px">
                <button id="sendNow" type="submit">Send Message</button>
                <button id="clearBtn" type="button" class="ghost">Clear</button>
              </div>
              <div id="sendResult" class="small muted" style="margin-top:8px"></div>
            </div>
          </form>
        </div>
      `);

      qs('#homeBtn').onclick = () => {
        history.pushState({}, '', '/');
        route();
      };

      const form = qs('#sendForm');
      form.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const name = qs('#senderName').value.trim();
        const text = qs('#senderText').value.trim();
        const out = qs('#sendResult');
        out.textContent = '';
        if (!text) { out.textContent = 'Message cannot be empty.'; return; }
        if (!linkId) { out.textContent = 'Invalid link id in URL.'; return; }
        try {
          qs('#sendNow').disabled = true;
          const res = await apiPost('/sendmessages', { linkId, name, text }, false);
          out.textContent = 'Message sent — thank you!';
          qs('#senderText').value = '';
          qs('#senderName').value = '';
        } catch (err) {
          out.textContent = 'Send failed: ' + (err.message || err);
        } finally {
          qs('#sendNow').disabled = false;
        }
      });

      qs('#clearBtn').onclick = () => {
        qs('#senderText').value = '';
        qs('#senderName').value = '';
      };
    }

    // ---------- Polling helpers ----------
    function startPolling(fn) {
      stopPolling();
      messagesPollId = setInterval(() => {
        // only call when user is visible on page
        if (document.visibilityState === 'visible') fn();
      }, pollIntervalMs);
    }
    function stopPolling() {
      if (messagesPollId) { clearInterval(messagesPollId); messagesPollId = null; }
    }

    // ---------- Utilities ----------
    function escapeHtml(s){
      if (!s) return '';
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    // ---------- Start ----------
    window.addEventListener('popstate', route);
    route();
  </script>
</body>
</html>

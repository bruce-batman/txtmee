<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asklyy — Send Anonymous Messages</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-primary: #0A1628;
            --bg-secondary: #132337;
            --bg-tertiary: #1E3A52;
            --card-base: rgba(19, 35, 55, 0.8);
            --card-border: rgba(255, 255, 255, 0.08);
            --accent-primary: #06B6D4;
            --accent-secondary: #14B8A6;
            --text-primary: #FFFFFF;
            --text-muted: #94A3B8;
            --text-success: #34D399;
            --text-error: #F87171;
            --stat-bg: rgba(6, 182, 212, 0.12);
            --stat-border: rgba(6, 182, 212, 0.3);
            color-scheme: dark;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            padding: 0;
            margin: 0;
            background-image: radial-gradient(circle at 20% 20%, rgba(6, 182, 212, 0.1) 0%, transparent 50%),
                              radial-gradient(circle at 80% 80%, rgba(20, 184, 166, 0.08) 0%, transparent 50%);
            font-size: 15px;
            line-height: 1.6;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }

        .narrow-container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }

        .card {
            background: var(--card-base);
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--card-border);
            backdrop-filter: blur(10px);
        }

        .landing-section {
            padding: 80px 20px;
            text-align: center;
        }

        .section-margin {
            margin-bottom: 80px;
        }

        header {
            margin-bottom: 24px;
        }

        .logo {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--accent-secondary), var(--accent-primary));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 24px;
            margin-bottom: 12px;
        }

        h1 {
            font-size: 40px;
            font-weight: 700;
            margin-bottom: 16px;
            line-height: 1.2;
        }

        h2 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 16px;
            line-height: 1.3;
        }

        h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .lead {
            font-size: 18px;
            color: var(--text-muted);
            line-height: 1.6;
        }

        .hero-title {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #06B6D4, #14B8A6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero-subtitle {
            font-size: 20px;
            color: var(--text-muted);
            margin-bottom: 40px;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }

        .muted {
            color: var(--text-muted);
            font-size: 13px;
        }

        .small {
            font-size: 12px;
            color: var(--text-muted);
        }

        input[type="text"],
        input[type="password"],
        textarea {
            width: 100%;
            padding: 14px 16px;
            font-size: 15px;
            background: var(--bg-secondary);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.15);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        button {
            padding: 14px 32px;
            font-size: 15px;
            font-weight: 500;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-family: 'Inter', sans-serif;
            justify-content: center;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button:not(.ghost):not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.5);
        }

        button:not(.ghost) {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
        }

        button:not(.ghost):hover {
            background: linear-gradient(135deg, #22d3ee, #2dd4bf);
        }

        button.ghost {
            background: transparent;
            border: 1px solid var(--card-border);
            color: var(--text-primary);
        }

        button.ghost:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--text-muted);
        }

        button.danger {
            background: var(--text-error);
            box-shadow: 0 2px 8px rgba(248, 113, 113, 0.3);
        }

        button.danger:hover {
            background: #f98989;
        }

        .row {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .col {
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex: 1;
        }

        .actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            gap: 20px;
        }

        .controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 16px;
            margin-top: 20px;
        }

        .link-card {
            background: var(--bg-tertiary);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--stat-border);
        }

        .link-card .content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            margin-top: 8px;
        }

        .link-card a {
            color: var(--text-primary);
            text-decoration: none;
            word-break: break-all;
            font-weight: 500;
        }

        .link-card a:hover {
            color: var(--accent-primary);
        }

        .stats-box {
            background: var(--stat-bg);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--stat-border);
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }

        .stats-box i {
            font-size: 20px;
            color: var(--accent-primary);
        }

        .stats-box .count {
            font-size: 32px;
            font-weight: 800;
            color: var(--accent-primary);
            line-height: 1;
        }

        .stats-box .label {
            font-size: 12px;
            color: var(--text-muted);
        }

        .messages {
            margin-top: 24px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .messages::-webkit-scrollbar {
            width: 6px;
        }

        .messages::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 3px;
        }

        .messages::-webkit-scrollbar-thumb {
            background: var(--stat-border);
            border-radius: 3px;
        }

        .message {
            background: var(--bg-secondary);
            padding: 14px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 3px solid var(--accent-primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .message:hover {
            background: var(--bg-tertiary);
            transform: translateX(4px);
        }

        .message .meta {
            font-size: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            color: var(--text-muted);
        }

        .message .content {
            font-size: 14px;
            line-height: 1.5;
            max-height: 3em;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background: var(--card-base);
            padding: 28px;
            border-radius: 12px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.7);
            border: 1px solid var(--accent-primary);
            transform: scale(0.95);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--card-border);
        }

        .modal-header h4 {
            margin: 0;
            font-size: 16px;
            color: var(--accent-primary);
            font-weight: 600;
        }

        .modal-close {
            background: transparent;
            color: var(--text-muted);
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        .message-full {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.6;
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--card-border);
            margin-bottom: 16px;
        }

        .notice {
            background: rgba(6, 182, 212, 0.1);
            border: 1px solid var(--stat-border);
            padding: 14px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 13px;
        }

        .error-text {
            color: var(--text-error);
        }

        .success-text {
            color: var(--text-success);
        }

        .center {
            text-align: center;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-top: 40px;
        }

        .feature-card {
            background: var(--card-base);
            padding: 32px 24px;
            border-radius: 12px;
            border: 1px solid var(--card-border);
            text-align: center;
            transition: all 0.3s;
        }

        .feature-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent-primary);
            box-shadow: 0 8px 24px rgba(6, 182, 212, 0.25);
        }

        .feature-icon {
            font-size: 40px;
            margin-bottom: 16px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .feature-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .feature-desc {
            font-size: 14px;
            color: var(--text-muted);
            line-height: 1.6;
        }

        .steps-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 32px;
            margin-top: 40px;
        }

        .step-card {
            text-align: center;
        }

        .step-number {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 700;
            margin: 0 auto 16px;
            color: white;
        }

        .step-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .step-desc {
            font-size: 14px;
            color: var(--text-muted);
            line-height: 1.6;
        }

        .auth-section {
            background: var(--card-base);
            padding: 60px 40px;
            border-radius: 12px;
            border: 1px solid var(--card-border);
            margin: 80px 20px;
        }

        .auth-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 60px;
            max-width: 900px;
            margin: 0 auto;
        }

        .auth-col {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .divider {
            width: 1px;
            background: var(--card-border);
        }

        @media (max-width: 768px) {
            .landing-section {
                padding: 60px 20px;
            }

            .hero-title {
                font-size: 36px;
            }

            .hero-subtitle {
                font-size: 18px;
            }

            h1 {
                font-size: 32px;
            }

            h2 {
                font-size: 24px;
            }

            .card {
                padding: 24px;
            }

            .header-controls {
                flex-direction: column;
                gap: 16px;
            }

            .controls {
                width: 100%;
                justify-content: flex-start;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .row {
                flex-direction: column;
            }

            .modal-content {
                padding: 24px;
            }

            .features-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .steps-grid {
                grid-template-columns: 1fr;
                gap: 32px;
            }

            .auth-grid {
                grid-template-columns: 1fr;
                gap: 40px;
            }

            .auth-section {
                padding: 40px 24px;
                margin: 60px 12px;
            }

            .divider {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="view"></div>
    </div>

    <div class="modal-overlay" id="messageModalOverlay">
        <div class="modal-content" id="messageModalContent"></div>
    </div>

    <script>
        // ========== MOCK BACKEND USING IN-MEMORY STORAGE ==========
        class MockBackend {
            constructor() {
                // Use in-memory storage instead of localStorage
                this.users = {};
                this.messages = {};
            }

            getUsers() {
                return this.users;
            }

            saveUsers(users) {
                this.users = users;
            }

            getMessages() {
                return this.messages;
            }

            saveMessages(messages) {
                this.messages = messages;
            }

            generateLinkId() {
                return 'link_' + Math.random().toString(36).substr(2, 9);
            }

            // Create new user account
            createLink(username, password) {
                const users = this.getUsers();
                
                if (!username || !password) {
                    throw new Error('Username and password are required');
                }

                if (users[username]) {
                    throw new Error('Username already exists');
                }

                const linkId = this.generateLinkId();
                users[username] = {
                    password: password, // In production, this would be hashed
                    linkId: linkId,
                    createdAt: new Date().toISOString()
                };

                this.saveUsers(users);

                // Initialize empty messages array for this link
                const messages = this.getMessages();
                messages[linkId] = [];
                this.saveMessages(messages);

                return { success: true, linkId: linkId };
            }

            // Authenticate user
            authenticate(username, password) {
                const users = this.getUsers();
                const user = users[username];

                if (!user || user.password !== password) {
                    throw new Error('Invalid username or password');
                }

                return { success: true, linkId: user.linkId };
            }

            // Get messages for a link
            getMessagesForLink(linkId, username, password) {
                // Verify authentication
                const users = this.getUsers();
                const user = users[username];

                if (!user || user.password !== password) {
                    throw new Error('Authentication failed');
                }

                if (user.linkId !== linkId) {
                    throw new Error('Link ID does not match user');
                }

                const messages = this.getMessages();
                const userMessages = messages[linkId] || [];

                return {
                    success: true,
                    linkId: linkId,
                    messages: userMessages
                };
            }

            // Send a message to a link
            sendMessage(linkId, name, text) {
                if (!text || !text.trim()) {
                    throw new Error('Message text is required');
                }

                const messages = this.getMessages();
                
                if (!messages[linkId]) {
                    throw new Error('Invalid link ID');
                }

                const newMessage = {
                    messageId: 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
                    name: name || '',
                    text: text,
                    createdAt: new Date().toISOString()
                };

                messages[linkId].push(newMessage);
                this.saveMessages(messages);

                return { success: true, messageId: newMessage.messageId };
            }

            // Delete account and all messages
            deleteAccount(username, password) {
                const users = this.getUsers();
                const user = users[username];

                if (!user || user.password !== password) {
                    throw new Error('Authentication failed');
                }

                const linkId = user.linkId;

                // Delete messages
                const messages = this.getMessages();
                delete messages[linkId];
                this.saveMessages(messages);

                // Delete user
                delete users[username];
                this.saveUsers(users);

                return { success: true };
            }
        }

        const backend = new MockBackend();

        // ========== APP STATE & ROUTING ==========
        const view = document.getElementById('view');
        const modalOverlay = document.getElementById('messageModalOverlay');
        const modalContent = document.getElementById('messageModalContent');
        
        let pollIntervalId = null;
        let currentMessages = [];

        // In-memory session storage
        let currentSession = {
            username: null,
            password: null,
            linkId: null
        };

        function getSession() {
            return { ...currentSession };
        }

        function setSession(username, password, linkId) {
            currentSession.username = username;
            currentSession.password = password;
            currentSession.linkId = linkId;
        }

        function clearSession() {
            currentSession.username = null;
            currentSession.password = null;
            currentSession.linkId = null;
        }

        function isAuthenticated() {
            const { username, password } = getSession();
            return !!(username && password);
        }

        function navigateToRoot() {
            history.pushState({}, '', '/');
            route();
        }

        function route() {
            const url = new URL(location.href);
            const path = location.pathname;
            const linkId = url.searchParams.get('id');

            if (path.startsWith('/send') || linkId) {
                const targetLinkId = linkId || path.split('/send/')[1]?.replace('/', '') || '';
                renderSendPage(targetLinkId);
                return;
            }

            if (isAuthenticated()) {
                renderDashboard();
            } else {
                renderMain();
            }
        }

        function qs(selector, root = document) {
            return root.querySelector(selector);
        }

        function qsa(selector, root = document) {
            return Array.from(root.querySelectorAll(selector));
        }

        function show(html) {
            view.innerHTML = html;
        }

        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function truncateMessage(text, limit = 100) {
            if (!text) return '';
            text = text.trim();
            if (text.length <= limit) return text;
            
            let short = text.substring(0, limit);
            const lastSpace = short.lastIndexOf(' ');
            if (lastSpace > 50) {
                short = short.substring(0, lastSpace);
            }
            return short + '...';
        }

        function startPolling(callback) {
            stopPolling();
            pollIntervalId = setInterval(() => {
                if (document.visibilityState === 'visible') {
                    callback();
                }
            }, 10000);
        }

        function stopPolling() {
            if (pollIntervalId) {
                clearInterval(pollIntervalId);
                pollIntervalId = null;
            }
        }

        // ========== MAIN PAGE (LOGIN/REGISTER) ==========
        function renderMain() {
            stopPolling();
            show(`
                <!-- Hero Section -->
                <div class="landing-section">
                    <div class="container">
                        <h1 class="hero-title">Asklyy</h1>
                        <p class="hero-subtitle">Receive anonymous messages securely. Share your unique link and let people send you honest, private feedback without revealing their identity.</p>
                    </div>
                </div>

                <!-- Auth Section -->
                <div class="auth-section">
                    <div class="auth-grid">
                        <div class="auth-col">
                            <h3 style="text-align: center; margin-bottom: 8px;"><i class="fas fa-plus-circle" style="color: var(--accent-primary); margin-right: 8px;"></i>Create Account</h3>
                            <p class="muted" style="text-align: center; margin-bottom: 16px; font-size: 14px;">Start receiving anonymous messages</p>
                            <input id="new_username" type="text" placeholder="Choose a username" />
                            <input id="new_password" type="password" placeholder="Choose a password" />
                            <button id="createBtn" style="width: 100%;"><i class="fas fa-magic"></i> Create Account</button>
                            <div id="createMsg" class="small" style="text-align: center; min-height: 18px;"></div>
                        </div>

                        <div class="auth-col">
                            <h3 style="text-align: center; margin-bottom: 8px;"><i class="fas fa-sign-in-alt" style="color: var(--accent-primary); margin-right: 8px;"></i>Sign In</h3>
                            <p class="muted" style="text-align: center; margin-bottom: 16px; font-size: 14px;">Access your dashboard</p>
                            <input id="login_username" type="text" placeholder="Your username" />
                            <input id="login_password" type="password" placeholder="Your password" />
                            <button id="loginBtn" style="width: 100%;"><i class="fas fa-arrow-right"></i> Sign In</button>
                            <div id="loginMsg" class="small" style="text-align: center; min-height: 18px;"></div>
                        </div>
                    </div>
                </div>

                <!-- Features Section -->
                <div class="landing-section section-margin" style="padding-top: 0;">
                    <div class="container">
                        <h2>Why Choose Asklyy?</h2>
                        <p class="lead" style="margin-bottom: 0;">Everything you need for secure anonymous messaging</p>
                        
                        <div class="features-grid">
                            <div class="feature-card">
                                <div class="feature-icon"><i class="fas fa-user-secret"></i></div>
                                <div class="feature-title">Anonymous Messaging</div>
                                <div class="feature-desc">Receive messages from anyone without knowing their identity</div>
                            </div>
                            
                            <div class="feature-card">
                                <div class="feature-icon"><i class="fas fa-shield-alt"></i></div>
                                <div class="feature-title">Secure &amp; Private</div>
                                <div class="feature-desc">Your messages are stored securely with privacy protection</div>
                            </div>
                            
                            <div class="feature-card">
                                <div class="feature-icon"><i class="fas fa-share-alt"></i></div>
                                <div class="feature-title">Easy Sharing</div>
                                <div class="feature-desc">Get a unique link to share on social media or with friends</div>
                            </div>
                            
                            <div class="feature-card">
                                <div class="feature-icon"><i class="fas fa-sync-alt"></i></div>
                                <div class="feature-title">Real-time Updates</div>
                                <div class="feature-desc">Messages appear instantly in your dashboard</div>
                            </div>
                            
                            <div class="feature-card">
                                <div class="feature-icon"><i class="fas fa-paper-plane"></i></div>
                                <div class="feature-title">No Sign-up for Senders</div>
                                <div class="feature-desc">Anyone can send you messages without creating an account</div>
                            </div>
                            
                            <div class="feature-card">
                                <div class="feature-icon"><i class="fas fa-tachometer-alt"></i></div>
                                <div class="feature-title">Simple Dashboard</div>
                                <div class="feature-desc">Clean interface to manage and view all your messages</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- How It Works Section -->
                <div class="landing-section section-margin" style="padding-top: 0;">
                    <div class="container">
                        <h2>How It Works</h2>
                        <p class="lead" style="margin-bottom: 0;">Get started in 4 simple steps</p>
                        
                        <div class="steps-grid">
                            <div class="step-card">
                                <div class="step-number">1</div>
                                <div class="step-title">Create Account</div>
                                <div class="step-desc">Sign up in seconds with just username and password</div>
                            </div>
                            
                            <div class="step-card">
                                <div class="step-number">2</div>
                                <div class="step-title">Get Your Link</div>
                                <div class="step-desc">Receive a unique shareable link for your profile</div>
                            </div>
                            
                            <div class="step-card">
                                <div class="step-number">3</div>
                                <div class="step-title">Share Link</div>
                                <div class="step-desc">Share your link on social media or with friends</div>
                            </div>
                            
                            <div class="step-card">
                                <div class="step-number">4</div>
                                <div class="step-title">Receive Messages</div>
                                <div class="step-desc">Get anonymous messages in your secure dashboard</div>
                            </div>
                        </div>
                    </div>
                </div>
            `);

            const createBtn = qs('#createBtn');
            const loginBtn = qs('#loginBtn');
            const createMsg = qs('#createMsg');
            const loginMsg = qs('#loginMsg');

            createBtn.onclick = async () => {
                const username = qs('#new_username').value.trim();
                const password = qs('#new_password').value;
                createMsg.textContent = '';

                if (!username || !password) {
                    createMsg.innerHTML = '<span class="error-text">Username and password are required.</span>';
                    return;
                }

                try {
                    createBtn.disabled = true;
                    createBtn.innerHTML = '<i class="fas fa-spinner fa-pulse"></i> Creating...';
                    
                    const result = backend.createLink(username, password);
                    setSession(username, password, result.linkId);
                    createMsg.innerHTML = '<span class="success-text"><i class="fas fa-check"></i> Account created successfully!</span>';
                    
                    setTimeout(() => navigateToRoot(), 500);
                } catch (err) {
                    createMsg.innerHTML = `<span class="error-text"><i class="fas fa-times"></i> ${escapeHtml(err.message)}</span>`;
                } finally {
                    createBtn.disabled = false;
                    createBtn.innerHTML = '<i class="fas fa-magic"></i> Generate Link';
                }
            };

            loginBtn.onclick = async () => {
                const username = qs('#login_username').value.trim();
                const password = qs('#login_password').value;
                loginMsg.textContent = '';

                if (!username || !password) {
                    loginMsg.innerHTML = '<span class="error-text">Please enter both username and password.</span>';
                    return;
                }

                try {
                    loginBtn.disabled = true;
                    loginBtn.innerHTML = '<i class="fas fa-spinner fa-pulse"></i> Verifying...';
                    
                    const result = backend.authenticate(username, password);
                    setSession(username, password, result.linkId);
                    loginMsg.innerHTML = '<span class="success-text"><i class="fas fa-check"></i> Login successful!</span>';
                    
                    setTimeout(() => navigateToRoot(), 500);
                } catch (err) {
                    loginMsg.innerHTML = `<span class="error-text"><i class="fas fa-times"></i> ${escapeHtml(err.message)}</span>`;
                } finally {
                    loginBtn.disabled = false;
                    loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Access Dashboard';
                }
            };

            // Allow Enter key to submit
            qs('#new_password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') createBtn.click();
            });
            qs('#login_password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') loginBtn.click();
            });
        }

        // ========== DASHBOARD ==========
        function renderDashboard() {
            const { username, linkId } = getSession();

            show(`
                <div class="narrow-container" style="padding: 40px 20px;">
                    <div class="card">
                    <div class="header-controls">
                        <div class="user-info">
                            <div style="font-weight: 600; font-size: 16px; color: var(--accent-primary); margin-bottom: 4px;">
                                <i class="fas fa-user-circle" style="margin-right: 8px;"></i>Welcome, ${escapeHtml(username)}
                            </div>
                            <div class="small muted">Your secure anonymous message center.</div>
                        </div>
                        <div class="controls">
                            <button id="refreshBtn" class="ghost" title="Refresh Messages">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                            <button id="logoutBtn" class="ghost">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </button>
                            <button id="deleteBtn" class="ghost danger">
                                <i class="fas fa-trash-alt"></i> Delete Account
                            </button>
                        </div>
                    </div>

                    <div class="dashboard-grid">
                        <div class="link-card">
                            <div class="small muted" style="margin-bottom: 8px;">
                                <i class="fas fa-link" style="margin-right: 5px;"></i> Your Shareable Link
                            </div>
                            <div class="content">
                                <div id="shareUrl"></div>
                                <div style="text-align: right; flex-shrink: 0;">
                                    <div class="small muted">Link ID</div>
                                    <div id="linkIdText" style="font-weight: 600; font-size: 14px; margin-top: 4px;"></div>
                                </div>
                            </div>
                        </div>

                        <div class="stats-box">
                            <i class="fas fa-envelope"></i>
                            <div id="messageCountDisplay" class="count">0</div>
                            <div class="label">Total Messages</div>
                        </div>
                    </div>

                    <div style="margin-top: 24px;">
                        <h3 style="margin-bottom: 12px;"><i class="fas fa-inbox" style="margin-right: 8px; color: var(--accent-primary);"></i>Your Messages</h3>
                        <div class="messages" id="messagesBox">
                            <div class="muted small center" style="padding: 20px;">Loading messages...</div>
                        </div>
                    </div>
                </div>
            `);

            const logoutBtn = qs('#logoutBtn');
            const deleteBtn = qs('#deleteBtn');
            const refreshBtn = qs('#refreshBtn');
            const linkIdText = qs('#linkIdText');
            const shareUrlEl = qs('#shareUrl');

            if (!linkId) {
                linkIdText.textContent = 'N/A';
                shareUrlEl.innerHTML = '<span class="error-text">Link ID unknown. Please re-login.</span>';
            } else {
                linkIdText.textContent = linkId;
                const fullUrl = `${location.origin}/send/?id=${encodeURIComponent(linkId)}`;
                shareUrlEl.innerHTML = `<a href="${fullUrl}" target="_blank">${fullUrl}</a>`;
            }

            logoutBtn.onclick = () => {
                stopPolling();
                clearSession();
                navigateToRoot();
            };

            deleteBtn.onclick = async () => {
                const confirmed = confirm('⚠️ WARNING: Delete your account and ALL messages? This cannot be undone!');
                if (!confirmed) return;

                try {
                    deleteBtn.disabled = true;
                    const { username, password } = getSession();
                    backend.deleteAccount(username, password);
                    alert('✓ Account successfully deleted.');
                    logoutBtn.click();
                } catch (err) {
                    alert('Error: ' + err.message);
                } finally {
                    deleteBtn.disabled = false;
                }
            };

            refreshBtn.onclick = async () => {
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Refreshing';
                await fetchAndRenderMessages(false);
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
                refreshBtn.disabled = false;
            };

            startPolling(() => fetchAndRenderMessages(true));
            fetchAndRenderMessages(false);
        }

        async function fetchAndRenderMessages(silent = false) {
            const box = qs('#messagesBox');
            const countDisplay = qs('#messageCountDisplay');
            const { username, password, linkId } = getSession();

            if (!linkId || !username || !password) {
                if (!silent) {
                    box.innerHTML = '<div class="muted small center" style="padding: 20px;"><span class="error-text">Error:</span> Session expired. Please log in again.</div>';
                }
                return;
            }

            try {
                const result = backend.getMessagesForLink(linkId, username, password);
                currentMessages = result.messages || [];
                
                if (countDisplay) {
                    countDisplay.textContent = currentMessages.length;
                }

                if (currentMessages.length === 0) {
                    box.innerHTML = '<div class="muted small center" style="padding: 20px;"><i class="fas fa-inbox" style="margin-right: 8px;"></i>No messages yet. Share your secure link!</div>';
                    return;
                }

                box.innerHTML = currentMessages.map(m => {
                    const name = m.name ? escapeHtml(m.name) : 'Anonymous';
                    const date = m.createdAt ? new Date(m.createdAt).toLocaleString() : 'Just now';
                    const truncated = truncateMessage(m.text, 100);

                    return `
                        <div class="message" data-id="${m.messageId}">
                            <div class="meta">
                                <span><i class="fas fa-user-secret" style="margin-right: 5px;"></i>${name}</span>
                                <span>${date}</span>
                            </div>
                            <div class="content">${escapeHtml(truncated)}</div>
                        </div>
                    `;
                }).join('');

                qsa('.message', box).forEach(el => {
                    el.onclick = () => openMessageModal(el.dataset.id);
                });

            } catch (err) {
                if (!silent) {
                    box.innerHTML = `<div class="muted small center" style="padding: 20px;"><span class="error-text">Error:</span> ${escapeHtml(err.message)}</div>`;
                }
            }
        }

        // ========== MESSAGE MODAL ==========
        function openMessageModal(messageId) {
            const message = currentMessages.find(m => String(m.messageId) === String(messageId));
            if (!message) {
                alert('Message not found.');
                return;
            }

            const name = message.name ? escapeHtml(message.name) : 'Anonymous';
            const date = message.createdAt ? new Date(message.createdAt).toLocaleString() : 'Just now';
            const text = escapeHtml(message.text || '');

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h4><i class="fas fa-envelope-open-text" style="margin-right: 8px;"></i>Full Message</h4>
                    <button id="modalCloseBtn" class="modal-close">&times;</button>
                </div>
                <div class="muted" style="margin-bottom: 12px; display: flex; justify-content: space-between;">
                    <span>From: <strong>${name}</strong></span>
                    <span>${date}</span>
                </div>
                <div class="message-full">${text}</div>
                <div class="actions" style="justify-content: flex-end;">
                    <button id="modalCopyBtn" style="background: var(--text-success); box-shadow: 0 2px 8px rgba(52, 211, 153, 0.3);">
                        <i class="fas fa-copy"></i> Copy Message
                    </button>
                </div>
                <div id="copyFeedback" class="small" style="margin-top: 12px; text-align: right; min-height: 18px;"></div>
            `;

            modalOverlay.classList.add('active');

            qs('#modalCloseBtn').onclick = closeMessageModal;
            qs('#modalCopyBtn').onclick = () => {
                const feedback = qs('#copyFeedback');
                navigator.clipboard.writeText(message.text).then(() => {
                    feedback.innerHTML = '<span class="success-text"><i class="fas fa-check"></i> Copied to clipboard!</span>';
                    setTimeout(() => feedback.textContent = '', 2000);
                }).catch(err => {
                    feedback.innerHTML = '<span class="error-text"><i class="fas fa-times"></i> Failed to copy.</span>';
                });
            };
        }

        function closeMessageModal() {
            modalOverlay.classList.remove('active');
        }

        // ========== SEND PAGE ==========
        function renderSendPage(linkId) {
            stopPolling();

            show(`
                <div class="narrow-container" style="padding: 40px 20px;">
                    <div class="card">
                    <div class="header-controls">
                        <div class="user-info">
                            <div style="font-weight: 600; font-size: 16px; color: var(--accent-primary); margin-bottom: 4px;">
                                <i class="fas fa-comment-dots" style="margin-right: 8px;"></i>Send A Secret Message
                            </div>
                            <div class="small muted">Sending to link ID: <strong style="color: var(--text-primary);">${escapeHtml(linkId)}</strong></div>
                        </div>
                        <div class="actions">
                            <button id="homeBtn" class="ghost"><i class="fas fa-arrow-left"></i> Back</button>
                        </div>
                    </div>

                    <form id="sendForm" style="margin-top: 20px;">
                        <div class="col">
                            <div>
                                <label class="small muted" style="display: block; margin-bottom: 8px;">Your identity (Optional - remains anonymous)</label>
                                <input id="senderName" type="text" placeholder="e.g. Someone who cares" />
                            </div>
                            <div>
                                <label class="small muted" style="display: block; margin-bottom: 8px;">Your secret message *</label>
                                <textarea id="senderText" rows="6" placeholder="Write your message here..." required></textarea>
                            </div>
                            <div class="actions">
                                <button id="sendBtn" type="submit" style="flex: 1;">
                                    <i class="fas fa-paper-plane"></i> Send Secret Message
                                </button>
                                <button id="clearBtn" type="button" class="ghost">
                                    <i class="fas fa-times"></i> Clear
                                </button>
                            </div>
                            <div id="sendResult" class="small" style="margin-top: 12px; min-height: 18px;"></div>
                        </div>
                    </form>

                    ${!linkId ? `
                        <div class="notice" style="margin-top: 20px;">
                            <i class="fas fa-exclamation-triangle"></i> <strong>Error:</strong> This link is missing a valid ID. Please check the URL.
                        </div>
                    ` : ''}
                    </div>
                </div>
            `);

            qs('#homeBtn').onclick = () => {
                history.pushState({}, '', '/');
                route();
            };

            const form = qs('#sendForm');
            const sendBtn = qs('#sendBtn');
            const clearBtn = qs('#clearBtn');
            const sendResult = qs('#sendResult');

            form.onsubmit = async (e) => {
                e.preventDefault();
                const name = qs('#senderName').value.trim();
                const text = qs('#senderText').value.trim();
                sendResult.textContent = '';

                if (!text) {
                    sendResult.innerHTML = '<span class="error-text">Message cannot be empty.</span>';
                    return;
                }

                if (!linkId) {
                    sendResult.innerHTML = '<span class="error-text">Invalid link ID. Cannot send.</span>';
                    return;
                }

                try {
                    sendBtn.disabled = true;
                    sendBtn.innerHTML = '<i class="fas fa-spinner fa-pulse"></i> Sending...';

                    backend.sendMessage(linkId, name, text);
                    sendResult.innerHTML = '<span class="success-text"><i class="fas fa-check-circle"></i> Message sent successfully!</span>';

                    qs('#senderText').value = '';
                    qs('#senderName').value = '';
                } catch (err) {
                    sendResult.innerHTML = `<span class="error-text"><i class="fas fa-times-circle"></i> ${escapeHtml(err.message)}</span>`;
                } finally {
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Secret Message';
                }
            };

            clearBtn.onclick = () => {
                qs('#senderText').value = '';
                qs('#senderName').value = '';
                sendResult.textContent = '';
            };
        }

        // ========== EVENT LISTENERS & INITIALIZATION ==========
        window.addEventListener('popstate', route);
        
        modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay) closeMessageModal();
        });
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modalOverlay.classList.contains('active')) {
                closeMessageModal();
            }
        });

        // Initialize app
        route();
    </script>
</body>
</html>

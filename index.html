<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Asklyy — Send Anonymous Messages</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-card: rgba(30, 41, 59, 0.7);
      --bg-glass: rgba(255, 255, 255, 0.05);
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --accent-primary: #3b82f6;
      --accent-secondary: #6366f1;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --border-light: rgba(255, 255, 255, 0.08);
      --border-medium: rgba(255, 255, 255, 0.12);
      --shadow-lg: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
      --shadow-xl: 0 20px 50px -12px rgba(0, 0, 0, 0.6);
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 14px;
      --radius-xl: 18px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      color-scheme: dark;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }

    body {
      margin: 0;
      background: linear-gradient(135deg, #0a1128 0%, var(--bg-primary) 50%, #1a1f3d 100%);
      min-height: 100vh;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      line-height: 1.6;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--accent-primary), transparent);
      z-index: 1;
    }

    .container {
      width: 100%;
      max-width: 1000px;
      position: relative;
      z-index: 2;
    }

    .card {
      background: var(--bg-card);
      backdrop-filter: blur(10px);
      padding: 32px;
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-xl);
      border: 1px solid var(--border-light);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--accent-primary), transparent);
    }

    header {
      display: flex;
      gap: 16px;
      align-items: center;
      margin-bottom: 24px;
    }

    .logo {
      width: 56px;
      height: 56px;
      border-radius: var(--radius-lg);
      background: linear-gradient(135deg, var(--accent-secondary), var(--accent-primary));
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: white;
      font-size: 24px;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      transition: var(--transition);
    }

    .logo:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
    }

    h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 700;
      background: linear-gradient(to right, #f1f5f9, #cbd5e1);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    p.lead {
      margin: 4px 0 0;
      color: var(--text-secondary);
      font-size: 16px;
      font-weight: 400;
    }

    .row {
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }

    .col {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    input[type="text"],
    input[type="password"],
    textarea {
      background: var(--bg-glass);
      border: 1px solid var(--border-light);
      padding: 14px 16px;
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: 15px;
      width: 100%;
      transition: var(--transition);
      font-weight: 400;
    }

    input[type="text"]:focus,
    input[type="password"]:focus,
    textarea:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
    }

    input[type="text"]::placeholder,
    input[type="password"]::placeholder,
    textarea::placeholder {
      color: var(--text-muted);
    }

    button {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      border: none;
      color: white;
      padding: 14px 20px;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-weight: 600;
      font-size: 15px;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    button.ghost {
      background: transparent;
      border: 1px solid var(--border-medium);
      color: var(--text-secondary);
      box-shadow: none;
    }

    button.ghost:hover {
      background: var(--bg-glass);
      border-color: var(--accent-primary);
      color: var(--accent-primary);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
    }

    button.danger {
      background: transparent;
      border: 1px solid var(--danger);
      color: var(--danger);
    }

    button.danger:hover {
      background: rgba(239, 68, 68, 0.1);
    }

    .muted {
      color: var(--text-muted);
      font-size: 14px;
    }

    .small {
      font-size: 13px;
      color: var(--text-muted);
    }

    .actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .link-card {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(99, 102, 241, 0.08));
      padding: 20px;
      border-radius: var(--radius-lg);
      color: #dbeafe;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid rgba(59, 130, 246, 0.15);
      transition: var(--transition);
    }

    .link-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.15);
    }

    .messages {
      margin-top: 20px;
      max-height: 420px;
      overflow: auto;
      padding-right: 8px;
    }

    /* Custom scrollbar */
    .messages::-webkit-scrollbar {
      width: 6px;
    }

    .messages::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
    }

    .messages::-webkit-scrollbar-thumb {
      background: var(--accent-primary);
      border-radius: 10px;
    }

    .message {
      background: var(--bg-glass);
      padding: 18px;
      border-radius: var(--radius-lg);
      margin-bottom: 12px;
      border: 1px solid var(--border-light);
      transition: var(--transition);
      position: relative;
    }

    .message:hover {
      background: rgba(255, 255, 255, 0.07);
      transform: translateY(-1px);
    }

    .message .meta {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .message .meta .name {
      font-weight: 600;
      color: var(--text-primary);
    }

    .controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .center {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      text-align: center;
    }

    .notice {
      padding: 16px;
      border-radius: var(--radius-lg);
      background: var(--bg-glass);
      margin-top: 16px;
      color: var(--text-secondary);
      font-size: 14px;
      border-left: 3px solid var(--accent-primary);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      background: var(--accent-primary);
      color: white;
    }

    .badge.ghost {
      background: transparent;
      border: 1px solid var(--border-medium);
      color: var(--text-secondary);
    }

    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-title i {
      color: var(--accent-primary);
    }

    .feature-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-top: 24px;
    }

    .feature-card {
      background: var(--bg-glass);
      padding: 20px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-light);
      transition: var(--transition);
    }

    .feature-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }

    .feature-icon {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-md);
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
      color: white;
      font-size: 20px;
    }

    .feature-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .feature-desc {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .empty-state {
      padding: 40px 20px;
      text-align: center;
      color: var(--text-muted);
    }

    .empty-state i {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 18px;
      margin-bottom: 8px;
      color: var(--text-secondary);
    }

    .empty-state p {
      font-size: 14px;
      max-width: 300px;
      margin: 0 auto;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: var(--accent-primary);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 16px 20px;
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      border-left: 4px solid var(--accent-primary);
      display: flex;
      align-items: center;
      gap: 12px;
      transform: translateY(100px);
      opacity: 0;
      transition: var(--transition);
      z-index: 1000;
      max-width: 400px;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast i {
      color: var(--accent-primary);
      font-size: 20px;
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .toast-message {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .toast-close {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 18px;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    @media (max-width: 768px) {
      body {
        padding: 16px;
      }
      
      .card {
        padding: 24px;
      }
      
      .row {
        flex-direction: column;
        align-items: stretch;
        gap: 16px;
      }
      
      .link-card {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      
      .controls {
        flex-wrap: wrap;
      }
      
      .feature-grid {
        grid-template-columns: 1fr;
      }
      
      .toast {
        left: 16px;
        right: 16px;
        bottom: 16px;
        max-width: none;
      }
    }

    @media (max-width: 480px) {
      .card {
        padding: 20px;
      }
      
      header {
        flex-direction: column;
        text-align: center;
        gap: 12px;
      }
      
      .actions {
        flex-direction: column;
        width: 100%;
      }
      
      .actions button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card" id="app">
      <header>
        <div class="logo">
          <i class="fas fa-comment-dots"></i>
        </div>
        <div>
          <h1>Asklyy</h1>
          <p class="lead">Create a shareable link and receive anonymous messages</p>
        </div>
      </header>

      <!-- MAIN / DASHBOARD / SEND views will be injected here -->
      <div id="view"></div>
    </div>
  </div>

  <div class="toast" id="toast">
    <i class="fas fa-check-circle"></i>
    <div class="toast-content">
      <div class="toast-title" id="toastTitle">Success</div>
      <div class="toast-message" id="toastMessage">Operation completed successfully</div>
    </div>
    <button class="toast-close" id="toastClose">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <script>
    /**
     * Frontend logic:
     * - root "/" shows create-account / login (and short info)
     * - dashboard shows link, messages (autorefresh every 10s), logout, delete account
     * - /send/?id=LINKID shows public send form
     *
     * Requirements: backend endpoints:
     *   POST /api/createlink    { username, password } => { success:true, linkId }
     *   GET  /api/getmessages?linkId=...   (protected - pass Authorization: Basic)
     *   POST /api/sendmessages   { linkId, name, text }  => accept anonymous submissions
     *   POST /api/dltlink        { linkId } (protected)
     *   POST /api/dltmessage     { linkId, messageId } (protected)
     *
     * The frontend stores username/password in sessionStorage while logged in (so refresh keeps session).
     */

    const API_PREFIX = '/api';
    const view = document.getElementById('view');
    const pollIntervalMs = 10000; // 10s
    let messagesPollId = null;
    let lastMessages = [];

    // ---------- Toast System ----------
    function showToast(title, message, duration = 5000) {
      const toast = document.getElementById('toast');
      const toastTitle = document.getElementById('toastTitle');
      const toastMessage = document.getElementById('toastMessage');
      
      toastTitle.textContent = title;
      toastMessage.textContent = message;
      
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, duration);
    }

    document.getElementById('toastClose').addEventListener('click', () => {
      document.getElementById('toast').classList.remove('show');
    });

    // ---------- Helpers ----------
    function show(html){ view.innerHTML = html; }
    function qs(sel, root=document) { return root.querySelector(sel); }
    function qsa(sel, root=document) { return Array.from(root.querySelectorAll(sel)); }

    function basicAuthHeader() {
      const u = sessionStorage.getItem('asklyy_username');
      const p = sessionStorage.getItem('asklyy_password');
      if (!u || !p) return null;
      return 'Basic ' + btoa(u + ':' + p);
    }

    async function apiPost(path, body, auth=false) {
      const headers = { 'Content-Type': 'application/json' };
      if (auth) {
        const h = basicAuthHeader();
        if (!h) throw new Error('Not authenticated');
        headers['Authorization'] = h;
      }
      const res = await fetch(API_PREFIX + path, { method: 'POST', headers, body: JSON.stringify(body) });
      const j = await res.json().catch(()=>({success:false, error:'Invalid JSON response'}));
      if (!res.ok) throw new Error(j && j.error ? j.error : 'API Error');
      return j;
    }

    async function apiGet(path, auth=false) {
      const headers = {};
      if (auth) {
        const h = basicAuthHeader();
        if (!h) throw new Error('Not authenticated');
        headers['Authorization'] = h;
      }
      const res = await fetch(API_PREFIX + path, { method:'GET', headers });
      const j = await res.json().catch(()=>({success:false, error:'Invalid JSON response'}));
      if (!res.ok) throw new Error(j && j.error ? j.error : 'API Error');
      return j;
    }

    function navigateToRoot() {
      history.replaceState({}, '', '/');
      route();
    }

    function route() {
      // If path starts with /send/ or query param id present -> show send page
      const url = new URL(location.href);
      const id = url.searchParams.get('id');
      if (location.pathname.startsWith('/send') || id) {
        const linkId = id || (location.pathname.split('/send/')[1] || '').replace('/', '');
        renderSendPage(linkId);
        return;
      }

      // else main/dashboard
      const username = sessionStorage.getItem('asklyy_username');
      const password = sessionStorage.getItem('asklyy_password');
      if (username && password) {
        renderDashboard();
      } else {
        renderMain();
      }
    }

    // ---------- MAIN (create / login) ----------
    function renderMain() {
      stopPolling();
      show(`
        <div>
          <h2 style="margin:0 0 10px">Welcome to Asklyy</h2>
          <p class="muted">Create a short link to receive anonymous messages. Share that link — people can send messages without logging in.</p>

          <div class="feature-grid">
            <div class="feature-card">
              <div class="feature-icon">
                <i class="fas fa-link"></i>
              </div>
              <div class="feature-title">Create Your Link</div>
              <div class="feature-desc">Generate a unique, shareable URL for receiving anonymous messages.</div>
            </div>
            <div class="feature-card">
              <div class="feature-icon">
                <i class="fas fa-user-secret"></i>
              </div>
              <div class="feature-title">100% Anonymous</div>
              <div class="feature-desc">Senders remain completely anonymous - no registration required.</div>
            </div>
            <div class="feature-card">
              <div class="feature-icon">
                <i class="fas fa-shield-alt"></i>
              </div>
              <div class="feature-title">Secure & Private</div>
              <div class="feature-desc">Your messages are protected and only you can access them.</div>
            </div>
          </div>

          <div class="row" style="margin-top:32px">
            <div class="col" style="flex:1;min-width:280px">
              <div class="section-title">
                <i class="fas fa-plus-circle"></i>
                <span>Create account & link</span>
              </div>
              <input id="new_username" placeholder="Choose a username (letters/numbers)" />
              <input id="new_password" placeholder="Choose a password" type="password" />
              <div class="actions">
                <button id="createBtn">
                  <i class="fas fa-plus"></i>
                  Create & Generate Link
                </button>
                <button id="demoBtn" class="ghost">
                  <i class="fas fa-bolt"></i>
                  Demo (quick)
                </button>
              </div>
              <div id="createMsg" class="small muted"></div>
            </div>

            <div class="col" style="flex:1;min-width:280px">
              <div class="section-title">
                <i class="fas fa-sign-in-alt"></i>
                <span>Already have an account?</span>
              </div>
              <input id="login_username" placeholder="Username" />
              <input id="login_password" type="password" placeholder="Password" />
              <div class="actions">
                <button id="loginBtn">
                  <i class="fas fa-sign-in-alt"></i>
                  Log in
                </button>
              </div>
              <div id="loginMsg" class="small muted"></div>
            </div>
          </div>

          <div class="notice">
            <strong>Shareable send URL format:</strong> <span id="exampleUrl" class="small"></span>
          </div>
        </div>
      `);

      const createBtn = qs('#createBtn');
      const loginBtn = qs('#loginBtn');
      const demoBtn = qs('#demoBtn');
      const ex = qs('#exampleUrl');
      ex.textContent = `${location.origin}/send/?id=your-link-id`;

      createBtn.onclick = async () => {
        const u = qs('#new_username').value.trim();
        const p = qs('#new_password').value;
        const msg = qs('#createMsg');
        msg.textContent = '';
        if (!u || !p) { 
          msg.textContent = 'Username & password required'; 
          showToast('Missing Information', 'Please enter both username and password', 3000);
          return; 
        }
        try {
          createBtn.innerHTML = '<div class="loading"></div> Creating...';
          createBtn.disabled = true;
          const res = await apiPost('/createlink', { username: u, password: p }, false);
          if (res && res.linkId) {
            sessionStorage.setItem('asklyy_username', u);
            sessionStorage.setItem('asklyy_password', p);
            sessionStorage.setItem('asklyy_linkId', res.linkId);
            showToast('Success', 'Your account and link have been created!', 3000);
            setTimeout(() => navigateToRoot(), 1000); // will go to dashboard
            return;
          }
          msg.textContent = 'Unexpected response from server';
        } catch (err) {
          msg.textContent = 'Error: ' + (err.message || err);
          showToast('Error', err.message || 'Failed to create account', 4000);
        } finally {
          createBtn.disabled = false;
          createBtn.innerHTML = '<i class="fas fa-plus"></i> Create & Generate Link';
        }
      };

      demoBtn.onclick = async () => {
        // demo quick flow: create a random username and password
        const demoU = 'demo' + Math.random().toString(36).slice(2,8);
        const demoP = Math.random().toString(36).slice(2,10);
        qs('#new_username').value = demoU;
        qs('#new_password').value = demoP;
        createBtn.click();
      };

      loginBtn.onclick = async () => {
        const u = qs('#login_username').value.trim();
        const p = qs('#login_password').value;
        const msg = qs('#loginMsg');
        msg.textContent = '';
        if (!u || !p) { 
          msg.textContent = 'Username & password required'; 
          showToast('Missing Information', 'Please enter both username and password', 3000);
          return; 
        }
        try {
          loginBtn.innerHTML = '<div class="loading"></div> Logging in...';
          loginBtn.disabled = true;
          // Store login credentials and attempt to access dashboard
          sessionStorage.setItem('asklyy_username', u);
          sessionStorage.setItem('asklyy_password', p);
          // Try to fetch messages to verify credentials
          try {
            // Attempt to get linkId from sessionStorage or try to fetch it
            const linkId = sessionStorage.getItem('asklyy_linkId');
            if (linkId) {
              await apiGet('/getmessages?linkId=' + encodeURIComponent(linkId), true);
            }
            showToast('Success', 'Login successful!', 2000);
            setTimeout(() => navigateToRoot(), 1000);
          } catch (err) {
            msg.textContent = 'Login failed: ' + (err.message || err);
            showToast('Login Failed', err.message || 'Invalid credentials', 4000);
            sessionStorage.removeItem('asklyy_username');
            sessionStorage.removeItem('asklyy_password');
          }
        } catch (err) {
          msg.textContent = 'Login error: ' + (err.message || err);
          showToast('Error', err.message || 'Login failed', 4000);
        } finally {
          loginBtn.disabled = false;
          loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Log in';
        }
      };
    }

    // ---------- DASHBOARD ----------
    async function renderDashboard() {
      const uname = sessionStorage.getItem('asklyy_username');
      let linkId = sessionStorage.getItem('asklyy_linkId') || '';
      
      show(`<div>
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px">
          <div>
            <div style="font-weight:700;font-size:20px">${uname || 'User'}</div>
            <div class="small muted">Manage your shareable link & messages</div>
          </div>
          <div class="controls">
            <div class="status-indicator">
              <div class="status-dot"></div>
              <span>Auto-refresh: 10s</span>
            </div>
            <button id="refreshBtn">
              <i class="fas fa-sync-alt"></i>
              Refresh
            </button>
            <button id="logoutBtn" class="ghost">
              <i class="fas fa-sign-out-alt"></i>
              Logout
            </button>
            <button id="deleteBtn" class="danger">
              <i class="fas fa-trash-alt"></i>
              Delete
            </button>
          </div>
        </div>

        <div style="margin-top:24px" class="link-card">
          <div>
            <div class="small muted">Share this URL to receive anonymous messages</div>
            <div id="shareUrl" style="font-weight:600;margin-top:6px;font-size:16px"></div>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
            <div class="small muted">Link ID</div>
            <div id="linkIdText" style="font-weight:700;font-size:16px"></div>
          </div>
        </div>

        <div class="section-title" style="margin-top:28px">
          <i class="fas fa-envelope"></i>
          <span>Messages</span>
          <span class="badge" id="messageCount">0</span>
        </div>
        
        <div class="messages" id="messagesBox">
          <div class="empty-state">
            <i class="fas fa-inbox"></i>
            <h3>No messages yet</h3>
            <p>Share your link to start receiving anonymous messages</p>
          </div>
        </div>
      </div>`);

      const logoutBtn = qs('#logoutBtn');
      const deleteBtn = qs('#deleteBtn');
      const refreshBtn = qs('#refreshBtn');
      const linkIdText = qs('#linkIdText');
      const shareUrlEl = qs('#shareUrl');
      const messageCount = qs('#messageCount');

      // If we don't have linkId in sessionStorage, try to obtain it
      if (!linkId) {
        linkIdText.textContent = '(unknown) — create an account first';
        shareUrlEl.textContent = '—';
      } else {
        linkIdText.textContent = linkId;
        shareUrlEl.innerHTML = `<a href="${location.origin}/send/?id=${encodeURIComponent(linkId)}" target="_blank" style="color:inherit; text-decoration:underline">${location.origin}/send/?id=${encodeURIComponent(linkId)}</a>`;
      }

      logoutBtn.onclick = () => {
        stopPolling();
        sessionStorage.removeItem('asklyy_username');
        sessionStorage.removeItem('asklyy_password');
        sessionStorage.removeItem('asklyy_linkId');
        showToast('Logged Out', 'You have been successfully logged out', 3000);
        setTimeout(() => navigateToRoot(), 1000);
      };

      deleteBtn.onclick = async () => {
        const ok = confirm('Delete your account and ALL messages for this link? This cannot be undone.');
        if (!ok) return;
        try {
          deleteBtn.innerHTML = '<div class="loading"></div> Deleting...';
          deleteBtn.disabled = true;
          const header = basicAuthHeader();
          if (!header) throw new Error('Not authenticated');
          // call delete link API
          const res = await apiPost('/dltlink', { linkId }, true);
          showToast('Account Deleted', 'Your account and all messages have been deleted', 4000);
          setTimeout(() => {
            logoutBtn.click();
          }, 1500);
        } catch (err) {
          alert('Delete failed: ' + (err.message || err));
          showToast('Error', err.message || 'Failed to delete account', 4000);
        } finally {
          deleteBtn.disabled = false;
          deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Delete';
        }
      };

      refreshBtn.onclick = async () => {
        await fetchAndRenderMessages(linkId, messageCount);
      };

      // Start polling messages every 10s when on this dashboard
      startPolling(() => fetchAndRenderMessages(linkId, messageCount));
      // initial fetch
      fetchAndRenderMessages(linkId, messageCount);
    }

    async function fetchAndRenderMessages(linkId, messageCountEl) {
      const box = qs('#messagesBox');
      if (!linkId) {
        box.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><h3>No link id known</h3><p>Create an account first</p></div>';
        if (messageCountEl) messageCountEl.textContent = '0';
        return;
      }
      try {
        // GET /api/getmessages?linkId=...   (requires auth)
        const res = await apiGet('/getmessages?linkId=' + encodeURIComponent(linkId), true);
        if (res && res.messages) {
          lastMessages = res.messages;
          if (messageCountEl) messageCountEl.textContent = res.messages.length.toString();
          
          if (res.messages.length === 0) {
            box.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><h3>No messages yet</h3><p>Share your link to start receiving anonymous messages</p></div>';
            return;
          }
          
          // render messages
          box.innerHTML = res.messages.map(m => {
            // message object: { messageId, name, text, createdAt }
            const name = m.name ? escapeHtml(m.name) : 'Anonymous';
            const text = escapeHtml(m.text || '');
            const date = m.createdAt ? new Date(m.createdAt).toLocaleString() : '';
            return `<div class="message">
                      <div class="meta">
                        <span class="name">${name}</span>
                        <span>•</span>
                        <span class="small muted">${date}</span>
                      </div>
                      <div>${text}</div>
                    </div>`;
          }).join('');
        } else {
          box.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><h3>No messages</h3><p>No messages to display</p></div>';
          if (messageCountEl) messageCountEl.textContent = '0';
        }
      } catch (err) {
        box.innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><h3>Error loading messages</h3><p>${escapeHtml((err && err.message) || String(err))}</p></div>`;
        if (messageCountEl) messageCountEl.textContent = '0';
      }
    }

    // ---------- SEND PAGE ----------
    function renderSendPage(linkIdFromUrl) {
      stopPolling();
      const linkId = linkIdFromUrl || '';
      show(`
        <div>
          <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px">
            <div>
              <div style="font-weight:700;font-size:20px">Send anonymous message</div>
              <div class="small muted">To link: <strong id="sendLinkId">${escapeHtml(linkId)}</strong></div>
            </div>
            <div class="actions">
              <button id="homeBtn" class="ghost">
                <i class="fas fa-arrow-left"></i>
                Home
              </button>
            </div>
          </div>

          <form id="sendForm" style="margin-top:24px">
            <div class="col">
              <label class="small muted">Your name (optional)</label>
              <input id="senderName" placeholder="Name (optional)" />
              <label class="small muted">Message</label>
              <textarea id="senderText" rows="5" placeholder="Write your anonymous message..." required></textarea>
              <div style="display:flex;gap:12px;margin-top:16px">
                <button id="sendNow" type="submit">
                  <i class="fas fa-paper-plane"></i>
                  Send Message
                </button>
                <button id="clearBtn" type="button" class="ghost">
                  <i class="fas fa-eraser"></i>
                  Clear
                </button>
              </div>
              <div id="sendResult" class="small muted" style="margin-top:12px"></div>
            </div>
          </form>
        </div>
      `);

      qs('#homeBtn').onclick = () => {
        history.pushState({}, '', '/');
        route();
      };

      const form = qs('#sendForm');
      form.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const name = qs('#senderName').value.trim();
        const text = qs('#senderText').value.trim();
        const out = qs('#sendResult');
        out.textContent = '';
        if (!text) { 
          out.textContent = 'Message cannot be empty.'; 
          showToast('Validation Error', 'Message cannot be empty', 3000);
          return; 
        }
        if (!linkId) { 
          out.textContent = 'Invalid link id in URL.'; 
          showToast('Error', 'Invalid link ID', 3000);
          return; 
        }
        try {
          qs('#sendNow').innerHTML = '<div class="loading"></div> Sending...';
          qs('#sendNow').disabled = true;
          const res = await apiPost('/sendmessages', { linkId, name, text }, false);
          out.textContent = 'Message sent — thank you!';
          showToast('Success', 'Your message has been sent anonymously!', 4000);
          qs('#senderText').value = '';
          qs('#senderName').value = '';
        } catch (err) {
          out.textContent = 'Send failed: ' + (err.message || err);
          showToast('Error', err.message || 'Failed to send message', 4000);
        } finally {
          qs('#sendNow').disabled = false;
          qs('#sendNow').innerHTML = '<i class="fas fa-paper-plane"></i> Send Message';
        }
      });

      qs('#clearBtn').onclick = () => {
        qs('#senderText').value = '';
        qs('#senderName').value = '';
        showToast('Cleared', 'Form has been cleared', 2000);
      };
    }

    // ---------- Polling helpers ----------
    function startPolling(fn) {
      stopPolling();
      messagesPollId = setInterval(() => {
        // only call when user is visible on page
        if (document.visibilityState === 'visible') fn();
      }, pollIntervalMs);
    }
    
    function stopPolling() {
      if (messagesPollId) { 
        clearInterval(messagesPollId); 
        messagesPollId = null; 
      }
    }

    // ---------- Utilities ----------
    function escapeHtml(s){
      if (!s) return '';
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    // ---------- Start ----------
    window.addEventListener('popstate', route);
    route();
  </script>
</body>
</html>

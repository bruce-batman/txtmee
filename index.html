<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Asklyy — Send & Receive Anonymous Messages</title>
    <meta name="description" content="Asklyy lets you send and receive anonymous messages instantly. Share your link and get honest feedback from anyone."/>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="preload" href="https://site-assets.fontawesome.com/releases/v6.4.2/css/all.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <style>
        /* --- 1. LUXURY COLOR PALETTE & VARIABLES (Asklyy Dark Mode) --- */
        :root {
            --bg-primary: #04091A; 
            --bg-secondary: #0F172A; 
            --bg-tertiary: #1D263B; 
            --card-base: rgba(15, 23, 42, 0.95); /* Slightly less blur base */
            --card-border: rgba(255, 255, 255, 0.08);
            --card-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
            --accent-primary: #4C72E0; 
            --accent-secondary: #7F58E8; 
            --accent-gradient: linear-gradient(135deg, var(--accent-secondary) 0%, var(--accent-primary) 100%);
            --text-primary: #EBF4F7;
            --text-muted: #A0B9D5;
            --text-success: #34D399; 
            --text-error: #F87171; 
            --stat-bg: rgba(76, 114, 224, 0.08);
            --stat-border: rgba(76, 114, 224, 0.3);
            --shadow-subtle: 0 2px 5px rgba(0, 0, 0, 0.5);
            
            color-scheme: dark;
        }

        /* --- 2. BASE STYLES & LAYOUT --- */
        * { box-sizing: border-box; font-family: 'Inter', system-ui, sans-serif; }
        body {
            margin: 0;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            padding-bottom: 50px;
            background-image: radial-gradient(circle at 10% 10%, rgba(76, 114, 224, 0.1) 1%, transparent 30%), 
                              radial-gradient(circle at 90% 90%, rgba(127, 88, 232, 0.08) 1%, transparent 35%);
        }
        .container { 
            width: 100%; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 0 15px; 
        }
        .d-flex-column { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            width: 100%; 
            padding-top: 20px;
        }
        
        /* Typography */
        h1 { font-size: 24px; margin: 0; }
        h2 { font-size: 20px; margin: 15px 0 10px; }
        p.lead { font-size: 13px; margin: 0; color: var(--text-muted); }
        .muted { color: var(--text-muted); font-size: 12px; }
        .small { font-size: 10px; color: var(--text-muted); }
        a { color: var(--accent-primary); text-decoration: none; }
        a:hover { text-decoration: underline; }

        /* Inputs & Buttons */
        input[type="text"], input[type="password"], textarea, select { 
            padding: 10px 12px;
            font-size: 14px;
            background: var(--bg-secondary);
            border: 1px solid var(--card-border);
            border-radius: 6px;
            color: var(--text-primary);
            width: 100%;
        }
        button, .btn { 
            padding: 9px 16px;
            font-size: 14px;
            line-height: 1.4; 
            border-radius: 6px;
            font-weight: 600;
            border: none;
            background: var(--accent-primary);
            color: var(--text-primary);
            box-shadow: 0 4px 10px rgba(76, 114, 224, 0.4);
            cursor: pointer;
            transition: transform 0.1s;
        }
        button:hover, .btn:hover { transform: translateY(-1px); }
        .btn--full { width: 100%; }
        .btn-icon i { margin-right: 8px; }
        
        /* Card/Wrapper Styles */
        .wrapper {
            background: var(--card-base);
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--card-border);
            backdrop-filter: blur(8px);
            margin-bottom: 20px;
        }
        .create-account-container { max-width: 420px; margin-top: 50px; }


        /* --- 3. NAVBAR & FOOTER --- */
        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--card-border);
        }
        .nav .logo h3 { font-size: 20px; margin: 0; color: var(--text-primary); }
        .navOpenBtn, .navCloseBtn { background: none; border: none; font-size: 24px; color: var(--text-primary); cursor: pointer; }
        .nav-links { display: flex; align-items: center; }
        .nav-links ul { display: flex; list-style: none; margin: 0; padding: 0; gap: 25px; }
        .nav-links li a { color: var(--text-primary); font-size: 15px; font-weight: 500; }
        .navCloseBtn { display: none; }
        
        footer {
            background: var(--bg-secondary);
            color: var(--text-muted);
            padding: 25px 0;
            text-align: center;
            border-top: 1px solid var(--card-border);
            margin-top: 30px;
        }
        footer hr { border: none; border-top: 1px solid var(--card-border); max-width: 400px; margin: 15px auto; }
        footer p { font-size: 12px; margin: 0; }


        /* --- 4. DASHBOARD & MESSAGE BOARD --- */
        .helloarea {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid var(--stat-border);
            width: 100%;
        }
        .hellouser { font-size: 18px; font-weight: 700; margin: 0; color: var(--accent-primary); }
        .helloicon { display: flex; gap: 15px; }
        .iconbg {
            font-size: 22px;
            color: var(--text-muted);
            cursor: pointer;
            transition: color 0.2s;
        }
        .iconbg:hover { color: var(--text-primary); }
        
        .messagehead { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-top: 20px;
            padding-bottom: 5px;
        }
        .messagehead h3 { margin: 0; font-size: 18px; color: var(--text-primary); }
        .reload-btn { background: none; border: none; color: var(--text-muted); font-size: 22px; padding: 5px; cursor: pointer;}
        .reload-icon.spin { animation: spin 0.8s linear; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        #messagesBox { margin-top: 15px; display: flex; flex-direction: column; gap: 10px; }
        .message {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--accent-primary);
            box-shadow: var(--shadow-subtle);
            cursor: pointer;
            transition: background-color 0.1s;
        }
        .message:hover { background-color: var(--bg-tertiary); }
        .message .mess { margin: 0; font-size: 15px; line-height: 1.4; max-height: 3em; overflow: hidden; text-overflow: ellipsis; }
        .message .timestamp { font-size: 12px; color: var(--text-muted); margin: 5px 0; display: block; }
        .message-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; font-size: 12px;}
        .message-footer p { margin: 0; color: var(--text-muted); }
        .icondele { color: var(--text-error); cursor: pointer; font-size: 16px; padding: 5px; }
        
        
        /* --- 5. MODALS & POPUPS --- */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 999;
            display: none;
            transition: opacity 0.3s;
        }
        .popupcred, .popup-share {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            padding: 25px;
            border-radius: 12px;
            background: var(--bg-tertiary);
            box-shadow: var(--card-shadow);
            border: 1px solid var(--accent-secondary);
            z-index: 1000;
            max-width: 90%; width: 380px;
            display: none;
        }

        /* Message Detail Modal (Slide-in from top) */
        #messageDetailModal {
            position: fixed;
            top: -100%; /* Start above screen */
            left: 50%;
            transform: translate(-50%, 0);
            padding: 25px;
            border-radius: 12px;
            background: var(--card-base);
            box-shadow: var(--card-shadow);
            border: 1px solid var(--accent-primary);
            z-index: 1001;
            max-width: 90%;
            width: 500px;
            transition: top 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: none;
        }
        #messageDetailModal.active {
            top: 20px;
            display: block;
        }
        #messageDetailModal .full-message {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 16px;
            line-height: 1.6;
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid var(--card-border);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .modal-header h4 { margin: 0; font-size: 18px; color: var(--accent-primary); }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed; bottom: 20px; right: 20px; z-index: 1002;
            display: flex; flex-direction: column; gap: 10px;
        }
        .toast {
            background-color: var(--text-success); color: var(--bg-primary); padding: 12px 18px;
            border-radius: 6px; font-size: 15px; font-weight: 600; opacity: 0; visibility: hidden;
            transform: translateY(20px); transition: all 0.3s;
        }
        .toast.show { opacity: 1; visibility: visible; transform: translateY(0); }
        .toast.error-toast { background-color: var(--text-error); }

        /* Mobile specific adjustments */
        @media (max-width: 768px) {
            .nav-links {
                position: fixed; top: 0; right: -100%; width: 70%; height: 100%;
                background: var(--bg-secondary); transition: right 0.3s; flex-direction: column;
                padding-top: 60px; z-index: 50; border-left: 1px solid var(--card-border);
            }
            .nav-links.active { right: 0; }
            .nav-links ul { flex-direction: column; gap: 20px; width: 100%; padding: 0 20px; }
            .navCloseBtn { position: absolute; top: 15px; right: 15px; }
            .helloicon { gap: 10px; }
            .iconbg { font-size: 20px; }
            .wrapper { padding: 20px; }
        }
    </style>
</head>

<body>
    <nav class="nav">
        <a href="/" class="logo" rel="noopener noreferrer">
            <h3>Asklyy</h3>
        </a>
       <button class="navOpenBtn" aria-label="Open Navigation Menu"> <i class="fa-light fa-bars"></i></button>
        <div class="nav-links">
            <button class="navCloseBtn" aria-label="Close Navigation Menu">
            <i class="fa-light fa-xmark"></i></button>
            <ul>
                <li><a href="/">Register</a></li>
                <li><a href="/login/">Login</a></li>
            </ul>
        </div>
    </nav>
    
    <div class="toast-container" id="toastContainer"></div> 

    <div class="d-flex-column">
        <div id="app-view" style="width: 100%;">
            </div>

        <div id="credentialPopup" class="popupcred">
            <span class="close-btn" onclick="closeCredentialPopup()"><i class="fa-solid fa-circle-xmark"></i></span>
                <h2>Login Details</h2>
                <hr>
                <h3 style="color: var(--text-success);">Take a Screenshot!</h3>
                <p>Link ID: <span id="popup_linkId" style="font-weight:700;"></span></p>
                <p>Password/PIN: <span id="popup_password" style="font-weight:700;"></span></p>
                <button class="btn" onclick="closeCredentialPopup()"> Done! </button>
        </div>

        <div id="sharePopup" class="popup-share">
            <span class="close-btn" onclick="closeSharePopup()"><i class="fa-solid fa-circle-xmark"></i></span>
            <div class="content">
              <h3>Share your link with friends</h3>
                <div class="field" style="display: flex; align-items: center;">
                    <i class="fa-light fa-link"></i>
                    <input type="text" id="shareLinkInput" value="" readonly style="flex-grow: 1; margin-right: 5px;"/>
                    <button onclick="copyLink()" style="flex-shrink: 0;"> Copy </button>
                </div>
                <ul class="icons" style="display: flex; justify-content: space-around; list-style: none; padding: 0; margin-top: 20px;">
                    <a id="waShare" target="_blank"><i class="fab fa-whatsapp"></i> </a>
                    <a id="fbShare" target="_blank"><i class="fab fa-facebook-f"></i> </a>
                    <a id="twitterShare" target="_blank"><i class="fa-brands fa-x-twitter"></i></a>
                    <a id="igShare" href="javascript:void(0)"><i class="fab fa-instagram"></i></a>
                    <a id="teleShare" target="_blank"><i class="fab fa-telegram-plane"></i></a>
                </ul>
            </div>
        </div>
        
        <div id="messageDetailModal">
            <div class="modal-header">
                <h4 id="modalSenderName"></h4>
                <button class="close-btn" onclick="hideMessageDetailModal()">&times;</button>
            </div>
            <p class="muted small" id="modalTimestamp"></p>
            <div class="full-message" id="modalMessageContent"></div>
            <div style="text-align: right;">
                <button class="btn" onclick="copyMessageToClipboard()"><i class="fas fa-copy"></i> Copy Message</button>
            </div>
        </div>

        
        <div id="overlay" class="overlay" onclick="closeCredentialPopup(); closeSharePopup(); hideMessageDetailModal();"></div>
    </div>


    <footer>
        <div class="container">
            <hr>
            <p>Copyright 2025 Asklyy. All Rights Reserved</p>
        </div>
    </footer>
    
<script>
    const API_PREFIX = '/api';
    const appView = document.getElementById('app-view');
    const overlay = document.getElementById('overlay');
    const credentialPopup = document.getElementById('credentialPopup');
    const sharePopup = document.getElementById('sharePopup');
    const messageDetailModal = document.getElementById('messageDetailModal');
    const toastContainer = document.getElementById('toastContainer');
    
    let messagesPollId = null;
    const pollIntervalMs = 10000;
    let lastMessages = []; 

    // --- Core Helpers ---
    function show(html) { appView.innerHTML = html; }
    function qs(sel, root = document) { return root.querySelector(sel); }
    function basicAuthHeader() {
        const u = sessionStorage.getItem('asklyy_username');
        const p = sessionStorage.getItem('asklyy_password');
        if (!u || !p) return null;
        return 'Basic ' + btoa(u + ':' + p);
    }
    function escapeHtml(s) {
        if (!s) return '';
        return String(s).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[c]));
    }
    
    // --- API Functions (MOCK IMPLEMENTATION - REPLACE WITH REAL BACKEND) ---
    async function apiPost(path, body, auth = false) {
        return new Promise((resolve, reject) => {
            setTimeout(() => {
                if (path === '/createlink') {
                    if (body.username && body.username.toLowerCase() === 'fail') return reject(new Error('Username taken.'));
                    const linkId = Math.random().toString(36).substring(2, 8).toUpperCase();
                    resolve({ success: true, linkId: linkId });
                } else if (path === '/sendmessages') {
                    if (!body.linkId || !body.text) return reject(new Error('Missing link ID or message text.'));
                    resolve({ success: true });
                } else if (path === '/dltlink') {
                    resolve({ success: true });
                } else {
                    reject(new Error('Invalid API path.'));
                }
            }, 500);
        });
    }

    async function apiGet(path, auth = false) {
        if (path.startsWith('/getmessages')) {
             if (!auth) throw new Error('Authentication Required');
             const mockMessages = [
                { messageId: 1, text: "Your design looks awesome, keep up the great work! This is a longer message that should demonstrate how text truncation works in the message list.", createdAt: new Date(Date.now() - 3600000).toISOString(), name: "A Fan" },
                { messageId: 2, text: "Just wanted to say hi anonymously!", createdAt: new Date(Date.now() - 86400000).toISOString(), name: "" },
                { messageId: 3, text: "This message is critical feedback about your recent project. It is honest, candid, and hopefully constructive. The system worked perfectly!", createdAt: new Date(Date.now() - 7200000).toISOString(), name: "The Critic" },
            ];
            return { success: true, linkId: sessionStorage.getItem('asklyy_linkId'), messages: mockMessages.reverse() };
        }
        return { success: true };
    }


    // --- Routing & Navigation ---
    function navigateToRoot() {
        history.replaceState({}, '', '/');
        route();
    }

    function route() {
        hideMessageDetailModal();
        closeCredentialPopup();
        closeSharePopup();

        const url = new URL(location.href);
        const id = url.searchParams.get('id');
        
        if (location.pathname === '/send' || location.pathname.startsWith('/send/') || id) {
            const linkId = id || (location.pathname.split('/send/')[1] || '').replace('/', '');
            renderSendPage(linkId);
            return;
        }

        const username = sessionStorage.getItem('asklyy_username');
        const password = sessionStorage.getItem('asklyy_password');
        if (username && password) {
            renderDashboard();
        } else {
            renderMain();
        }
    }
    
    // --- Toast & Popup Handlers ---
    function showToast(message, isError = false) {
        const toast = document.createElement("div");
        toast.className = `toast show ${isError ? 'error-toast' : ''}`;
        toast.innerHTML = `<span>${message}</span>`;
        toastContainer.appendChild(toast);

        setTimeout(() => {
            toast.classList.remove("show");
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
    
    function closeCredentialPopup() { credentialPopup.style.display = 'none'; overlay.style.display = 'none'; }
    function openCredentialPopup() { 
        qs('#popup_linkId').textContent = sessionStorage.getItem('asklyy_linkId') || 'N/A';
        qs('#popup_password').textContent = sessionStorage.getItem('asklyy_password') || 'N/A';
        credentialPopup.style.display = 'block'; 
        overlay.style.display = 'block'; 
    }

    function closeSharePopup() { sharePopup.style.display = 'none'; overlay.style.display = 'none'; }
    function openSharePopup() {
        const linkId = sessionStorage.getItem('asklyy_linkId');
        const username = sessionStorage.getItem('asklyy_username') || 'a friend';
        if (!linkId) return showToast('Error: No link ID found to share.', true);
        
        const shareUrl = `${location.origin}/send?id=${encodeURIComponent(linkId)}`;
        const baseText = `Hey, it’s ${username} here! 👋 Got something to say? 🤫 Share your secrets anonymously. Share them here 💌👉 ${shareUrl}`;

        qs('#shareLinkInput').value = shareUrl;

        const encodedUrl = encodeURIComponent(shareUrl);
        const encodedText = encodeURIComponent(baseText);

        qs('#waShare').href = `https://wa.me/?text=${encodedText}`;
        qs('#fbShare').href = `https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}&quote=${encodedText}`;
        qs('#twitterShare').href = `https://twitter.com/intent/tweet?url=${encodedUrl}&text=${encodedText}`;
        qs('#teleShare').href = `https://t.me/share/url?url=${encodedUrl}&text=${encodedText}`;
        
        sharePopup.style.display = 'block';
        overlay.style.display = 'block';
    }

    function copyLink() {
        const copyText = qs("#shareLinkInput");
        copyText.select();
        copyText.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(copyText.value)
            .then(() => showToast('✅ Link copied to clipboard!'))
            .catch(() => showToast("Failed to copy link. Please try manually.", true));
    }
    
    function showMessageDetailModal(message) {
        qs('#modalSenderName').innerHTML = `Full Message from <i class="fas fa-user-secret" style="margin-right: 5px;"></i>${message.name || 'Anonymous'}`;
        qs('#modalTimestamp').textContent = new Date(message.createdAt).toLocaleString();
        qs('#modalMessageContent').textContent = message.text;
        messageDetailModal.dataset.fullText = message.text;
        
        messageDetailModal.classList.add('active');
        overlay.style.display = 'block';
    }

    function hideMessageDetailModal() {
        messageDetailModal.classList.remove('active');
        // Only hide overlay if no other popups are active
        if (credentialPopup.style.display !== 'block' && sharePopup.style.display !== 'block') {
             overlay.style.display = 'none';
        }
    }

    function copyMessageToClipboard() {
        const textToCopy = messageDetailModal.dataset.fullText;
        navigator.clipboard.writeText(textToCopy).then(() => {
            showToast('✅ Full message copied to clipboard!');
        }).catch(() => {
            showToast('Failed to copy.', true);
        });
    }

    // --- Time Utility ---
    function timeSince(date, now) {
        const seconds = Math.floor((now - date) / 1000);
        let interval = seconds / 31536000;
        if (interval > 1) return Math.floor(interval) + " years ago";
        interval = seconds / 2592000;
        if (interval > 1) return Math.floor(interval) + " months ago";
        interval = seconds / 86400;
        if (interval > 1) return Math.floor(interval) + " days ago";
        interval = seconds / 3600;
        if (interval > 1) return Math.floor(interval) + " hours ago";
        interval = seconds / 60;
        if (interval > 1) return Math.floor(interval) + " minutes ago";
        return "Just now";
    }

    function updateTimestamps() {
        const now = new Date();
        document.querySelectorAll('.timestamp').forEach(element => {
            const timeString = element.getAttribute('data-time');
            const time = new Date(timeString); 
            const relativeTime = timeSince(time, now);
            element.innerHTML = relativeTime;
        });
    }


    // --- View Functions ---
    function renderMain() {
        stopPolling();
        
        show(`
            <div class="wrapper container create-account-container">
                <div class="title" style="text-align: center;">
                    <h1 class="mainheading">Asklyy</h1>
                    <p class="headerstyle lead">Create Your Anonymous Link <br>&amp; Send Secret Messages</p>
                </div>

                <div id="auth-switch">
                    ${renderCreateForm()}
                </div>
            </div>

            <div class="container" style="margin-top: 20px; text-align: center;">
                <p class="muted small" style="margin-bottom: 10px;">
                    Already have an account? <a href="javascript:void(0)" onclick="switchAuthView()">Login here</a>
                </p>
                <div class="notice">
                    <strong>Quick Demo:</strong> Leave the password blank and click "Generate Link" for instant, temporary access.
                </div>
            </div>
        `);
        
        window.switchAuthView = () => {
             const isNowLogin = !qs('#auth-switch').querySelector('form').dataset.mode.includes('create');
             qs('#auth-switch').innerHTML = isNowLogin ? renderLoginForm() : renderCreateForm();
             attachAuthHandlers();
        }

        attachAuthHandlers();
    }

    function renderCreateForm() {
        return `
            <form id="createForm" data-mode="create" style="margin-top: 20px;">
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <input id="new_username" type="text" placeholder="Choose a unique username" required />
                    <input id="new_password" type="password" placeholder="Choose a strong password (optional for demo)" />
                    
                    <button id="createBtn" class="btn btn--full w-100 btn-icon" type="submit">
                        <i class="fa-regular fa-link-simple"></i> Generate Link
                    </button>
                    <div id="createMsg" class="small" style="text-align: center;"></div>
                </div>
            </form>
        `;
    }

    function renderLoginForm() {
        return `
            <form id="loginForm" data-mode="login" style="margin-top: 20px;">
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <input id="login_username" type="text" placeholder="Your Username" required />
                    <input id="login_password" type="password" placeholder="Your Password" required />
                    <button id="loginBtn" class="btn btn--full w-100 btn-icon" type="submit">
                        <i class="fas fa-sign-in-alt"></i> Access Dashboard
                    </button>
                    <div id="loginMsg" class="small" style="text-align: center;"></div>
                </div>
            </form>
        `;
    }

    function attachAuthHandlers() {
        const createForm = qs('#createForm');
        if (createForm) {
            createForm.onsubmit = async (e) => {
                e.preventDefault();
                const u = qs('#new_username').value.trim();
                const p = qs('#new_password').value;
                const msg = qs('#createMsg');
                const btn = qs('#createBtn');
                
                let finalU = u, finalP = p;
                
                if (!u) { msg.innerHTML = '<span style="color:var(--text-error);">Username required.</span>'; return; }
                if (!p) {
                     finalP = Math.random().toString(36).slice(2,10);
                     msg.textContent = 'Creating demo credentials...';
                }

                try {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-cog fa-spin"></i> Processing...';
                    const res = await apiPost('/createlink', { username: finalU, password: finalP }, false);
                    
                    if (res && res.linkId) {
                        sessionStorage.setItem('asklyy_username', finalU);
                        sessionStorage.setItem('asklyy_password', finalP);
                        sessionStorage.setItem('asklyy_linkId', res.linkId);
                        
                        showToast('✅ Link created!');
                        openCredentialPopup(); 
                        navigateToRoot();
                    } else {
                        throw new Error('Unexpected response.');
                    }
                } catch (err) {
                    msg.innerHTML = `<span style="color:var(--text-error);">Error: ${escapeHtml(err.message)}</span>`;
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-regular fa-link-simple"></i> Generate Link';
                }
            };
        }

        const loginForm = qs('#loginForm');
        if (loginForm) {
            loginForm.onsubmit = async (e) => {
                e.preventDefault();
                const u = qs('#login_username').value.trim();
                const p = qs('#login_password').value;
                const msg = qs('#loginMsg');
                const btn = qs('#loginBtn');

                if (!u || !p) { msg.textContent = 'Please enter both username and password.'; return; }
                
                try {
                    sessionStorage.setItem('asklyy_username', u);
                    sessionStorage.setItem('asklyy_password', p);
                    
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-pulse"></i> Verifying...';
                    
                    const res = await apiGet('/getmessages?linkId=temp', true);
                    
                    if (res && res.linkId) {
                        sessionStorage.setItem('asklyy_linkId', res.linkId);
                        showToast('✅ Login successful!');
                        navigateToRoot();
                    } else {
                        throw new Error('Link ID not found.');
                    }
                } catch (err) {
                    msg.innerHTML = `<span style="color:var(--text-error);">Login failed: Check credentials.</span>`;
                    sessionStorage.removeItem('asklyy_username');
                    sessionStorage.removeItem('asklyy_password');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Access Dashboard';
                }
            };
        }
    }


    async function renderDashboard() {
        stopPolling();
        const uname = sessionStorage.getItem('asklyy_username') || 'User';
        const linkId = sessionStorage.getItem('asklyy_linkId') || 'N/A';

        show(`
            <div class="container helloarea">
                <div><p class="hellouser">Hello ${escapeHtml(uname)}</p></div>
                <div class="helloicon">
                    <i class="fa-regular fa-key iconbg" id="openCredsBtn" title="Show Login Details"></i>
                    <a href="#messageBoard"> <i class="fa-regular fa-message-lines iconbg" title="Go to Message Board"></i> </a>
                    <i class="fa-regular fa-share-nodes iconbg" id="openShareBtn" title="Share your link"></i>
                    <i class="fa-regular fa-arrow-right-from-bracket iconbg" id="logoutBtn" title="Logout"></i>
                </div>
            </div>

            <div class="wrapper container" style="margin-top: 20px;">
                <div class="content" style="text-align: center;">
                    <h3>Your Anonymous Link is Ready</h3>
                    <div class="field" style="display: flex; align-items: center;">
                        <i class="fa-light fa-link"></i>
                        <input type="text" id="shareLinkDisplay" value="${location.origin}/send?id=${escapeHtml(linkId)}" readonly style="flex-grow: 1; margin-right: 5px;" />
                        <button onclick="openSharePopup()" style="flex-shrink: 0;"> Share </button>
                    </div>
                </div>
            </div>

            <div class="container" style="margin-top: 20px;">
                <section>
                    <div class="messagehead" id="messageBoard">
                        <h3>Message Board</h3>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn ghost" id="deleteAccountBtn" style="color:var(--text-error); border-color:var(--text-error); padding: 5px 10px;"><i class="fas fa-trash-alt"></i> Delete</button>
                            <button class="reload-btn" id="reloadButton">
                                <i class="fa-regular fa-arrow-rotate-right reload-icon" id="reloadIcon"></i>
                            </button>
                        </div>
                    </div>
                    <div id="messagesBox">
                        <div class="muted small" style="padding: 20px; text-align: center;">Loading messages...</div>
                    </div>
                </section>
            </div>
        `);

        // Attach Dashboard Handlers
        qs('#openCredsBtn').onclick = openCredentialPopup;
        qs('#openShareBtn').onclick = openSharePopup;
        qs('#logoutBtn').onclick = () => {
            stopPolling();
            sessionStorage.clear();
            showToast('Logged out.');
            navigateToRoot();
        };
        
        const reloadButton = qs('#reloadButton');
        reloadButton.onclick = async () => {
            const icon = qs("#reloadIcon");
            icon.classList.add("spin");
            await fetchAndRenderMessages(linkId);
            setTimeout(() => icon.classList.remove("spin"), 800);
            showToast('Messages refreshed.');
        };

        qs('#deleteAccountBtn').onclick = async () => {
            const ok = confirm('FINAL WARNING: Delete your account and ALL messages? This cannot be reversed.');
            if (!ok) return;
            try {
                qs('#deleteAccountBtn').disabled = true;
                await apiPost('/dltlink', { linkId }, true);
                showToast('Account successfully deleted.', true);
                qs('#logoutBtn').click();
            } catch (err) {
                showToast('Deletion failed: ' + (err.message || 'Server Error'), true);
            } finally {
                qs('#deleteAccountBtn').disabled = false;
            }
        };

        startPolling(() => fetchAndRenderMessages(linkId, true)); 
        fetchAndRenderMessages(linkId);
    }
    
    // --- Message Fetching & Rendering ---
    async function fetchAndRenderMessages(linkId, silent = false) {
        const box = qs('#messagesBox');
        
        try {
            const res = await apiGet('/getmessages?linkId=' + encodeURIComponent(linkId), true);
            if (res && res.messages) {
                lastMessages = res.messages;
                
                if (lastMessages.length === 0) {
                    box.innerHTML = '<div class="muted small" style="padding: 20px; text-align: center;"><i class="fas fa-inbox" style="margin-right: 8px;"></i>No messages yet. Share your link!</div>';
                    return;
                }
                
                box.innerHTML = lastMessages.map(m => {
                    const messageText = m.text;
                    return `<div class="message" data-id="${m.messageId}">
                        <p class="mess">${escapeHtml(messageText)}</p>
                        <p class='timestamp' data-time='${m.createdAt}'>Loading...</p>
                        <div class="message-footer">
                        <p>💌 asklyy.com | From: ${m.name || 'Anonymous'}</p>
                        <i class="fas fa-trash-alt icondele" onclick='deleteMessage(event, ${m.messageId})' title="Delete Message"></i>
                        </div>
                    </div>`;
                }).join('');
                
                // Attach click handlers for detail modal
                document.querySelectorAll('.message').forEach(el => {
                    el.onclick = () => {
                        const messageId = parseInt(el.dataset.id);
                        const message = lastMessages.find(m => m.messageId === messageId);
                        if (message) showMessageDetailModal(message);
                    };
                });
                
                updateTimestamps();

            } else if (!silent) {
                box.innerHTML = '<div class="muted small" style="padding: 20px; text-align: center;"><span style="color:var(--text-error);">Server Error:</span> Failed to load messages.</div>';
            }
        } catch (err) {
            if (!silent) {
                box.innerHTML = `<div class="muted small" style="padding: 20px; text-align: center;"><span style="color:var(--text-error);">Connection Error:</span> ${escapeHtml(err.message || 'Authentication Failed')}</div>`;
            }
        }
    }
    
    // Placeholder function for client-side delete
    window.deleteMessage = async (event, id) => {
        event.stopPropagation(); // Prevent message detail modal from opening
        if (!confirm("Are you sure you want to delete this message?")) return;
        try {
             await new Promise(resolve => setTimeout(resolve, 300));
             lastMessages = lastMessages.filter(m => m.messageId !== id);
             showToast('🗑️ Message deleted.', true);
             fetchAndRenderMessages(sessionStorage.getItem('asklyy_linkId'));
        } catch (error) {
            showToast('Failed to delete message.', true);
        }
    }

    // --- Send Page View (Corrected with Optional Name) ---
    function renderSendPage(linkIdFromUrl) {
        stopPolling();
        const linkId = linkIdFromUrl || '';
        // MOCK: Get recipient's username using a mock function (replace with real API call)
        const recipientName = 'Recipient'; 

        show(`
            <div class="wrapper container create-account-container" style="max-width: 450px; margin-top: 50px;">
                <div class="title" style="text-align: center;">
                    <h1 class="sendtitle">Send a Secret <br> Message to ${escapeHtml(recipientName)}</h1>
                    <p class="sendpara lead muted">They will never know who messaged them 😉</p>
                </div>
                
                <form id="sendForm" style="margin-top:20px">
                    <input type="hidden" name="linkId" value="${escapeHtml(linkId)}">
                    
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        
                        <div>
                            <label class="small muted" style="display:block; margin-bottom: 5px;">Your identity (Optional - remains anonymous)</label>
                            <input id="senderName" type="text" placeholder="e.g. Someone who cares" />
                        </div>

                        <div>
                            <label class="small muted" style="display:block; margin-bottom: 5px;">Your secret message</label>
                            <textarea id="senderText" rows="5" placeholder="Write your anonymous message here..." required></textarea>
                        </div>
                        
                        <button id="sendNow" class="btn btn--full w-100" type="submit">
                            <i class="fas fa-paper-plane"></i> Send Secret Message
                        </button>
                        <div id="sendResult" class="small" style="text-align: center;"></div>
                    </div>
                </form>
                
                ${!linkId ? `<div class="notice" style="margin-top: 20px;">
                    <i class="fas fa-exclamation-triangle"></i> <strong>Error:</strong> This link is missing a valid ID.
                </div>` : ''}
            </div>
        `);
        
        const form = qs('#sendForm');
        form.onsubmit = async (ev) => {
            ev.preventDefault();
            const text = qs('#senderText').value.trim();
            const name = qs('#senderName').value.trim();
            const out = qs('#sendResult');
            
            if (!text) { out.innerHTML = '<span style="color:var(--text-error);">Message cannot be empty.</span>'; return; }
            if (!linkId) { out.innerHTML = '<span style="color:var(--text-error);">Invalid link ID. Cannot send.</span>'; return; }
            
            try {
                qs('#sendNow').disabled = true;
                qs('#sendNow').innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Sending...';
                await apiPost('/sendmessages', { linkId, name, text }, false);
                
                out.innerHTML = '<span style="color:var(--text-success);"><i class="fas fa-check-circle"></i> Message sent successfully!</span>';
                qs('#senderText').value = '';
                qs('#senderName').value = '';
            } catch (err) {
                out.innerHTML = `<span style="color:var(--text-error);"><i class="fas fa-times-circle"></i> Send failed: ${escapeHtml(err.message || 'Server error.')}</span>`;
            } finally {
                qs('#sendNow').disabled = false;
                qs('#sendNow').innerHTML = '<i class="fas fa-paper-plane"></i> Send Secret Message';
            }
        };
    }

    // --- Global Init ---
    document.addEventListener("DOMContentLoaded", function() {
        route();
        setInterval(updateTimestamps, 60000);

        // Mobile Menu Toggle
        qs('.navOpenBtn').onclick = () => qs('.nav-links').classList.add('active');
        qs('.navCloseBtn').onclick = () => qs('.nav-links').classList.remove('active');
    });

    window.addEventListener('popstate', route);
</script>
</body>
</html>
